{% extends "base.html" %}

{% block title %}Issuer - Academic Institution{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-dark sidebar collapse">
            <div class="position-sticky pt-3">
                <div class="text-center mb-3">
                    <i class="fas fa-university fa-3x text-primary"></i>
                    <h6 class="mt-2">Issuer Portal</h6>
                    <small class="user-name-bold">{{ session.full_name }}</small>
                </div>
                
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="showSection('issue'); return false;">
                            <i class="fas fa-plus-circle me-2"></i>Issue Credential
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('manage'); return false;">
                            <i class="fas fa-list me-2"></i>Manage Credentials
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('search'); return false;">
                            <i class="fas fa-search me-2"></i>Search Student
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('tickets'); return false;">
                            <i class="fas fa-ticket-alt me-2"></i>Tickets
                            <span class="badge bg-warning text-dark" id="ticketBadge">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('messages'); return false;">
                            <i class="fas fa-envelope me-2"></i>Messages
                        </a>
                    </li>
                </ul>
                
                <hr>
                
                <div class="px-3">
                    <small class="stats-header-bold">Quick Stats</small>
                    <div class="mt-2">
                        <div class="d-flex justify-content-between">
                            <span class="small">Total Issued:</span>
                            <span class="badge bg-primary" id="totalCredsBadge">0</span>
                        </div>
                        <div class="d-flex justify-content-between mt-1">
                            <span class="small">Open Tickets:</span>
                            <span class="badge bg-warning text-dark" id="pendingTicketsBadge">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h2 id="sectionTitle"><i class="fas fa-plus-circle text-primary me-2"></i>Issue New Credential</h2>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="loadDashboardData()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>
            </div>

            <!-- SECTION 1: Issue Credential (UNCHANGED) -->
            <div id="issueSection" class="content-section">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-certificate me-2"></i>New Credential Form</h5>
                            </div>
                            <div class="card-body">
                                <form id="issueCredentialForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="studentName" class="form-label">Student Name *</label>
                                            <input type="text" class="form-control" id="studentName" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="studentId" class="form-label">Roll Number *</label>
                                            <input type="text" class="form-control" id="studentId" required>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="degree" class="form-label">Degree Program *</label>
                                            <select class="form-select" id="degree" required>
                                                <option value="">Select Degree</option>
                                                <option value="B.Tech Computer Science">B.Tech Computer Science</option>
                                                <option value="B.Tech Electronics">B.Tech Electronics</option>
                                                <option value="B.Tech Mechanical">B.Tech Mechanical</option>
                                                <option value="B.Tech Civil">B.Tech Civil</option>
                                                <option value="M.Tech Computer Science">M.Tech Computer Science</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="university" class="form-label">University *</label>
                                            <input type="text" class="form-control" id="university" value="G. Pulla Reddy Engineering College" required>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-3 mb-3">
                                            <label for="semester" class="form-label">Semester</label>
                                            <select class="form-select" id="semester">
                                                <option value="">Select</option>
                                                {% for i in range(1,9) %}
                                                <option value="{{ i }}">{{ i }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label for="year" class="form-label">Year</label>
                                            <select class="form-select" id="year">
                                                <option value="">Select</option>
                                                <option value="1">I Year</option>
                                                <option value="2">II Year</option>
                                                <option value="3">III Year</option>
                                                <option value="4">IV Year</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label for="className" class="form-label">Class</label>
                                            <input type="text" class="form-control" id="className" placeholder="e.g., B.Tech">
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label for="section" class="form-label">Section</label>
                                            <input type="text" class="form-control" id="section" placeholder="e.g., A/B">
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="gpa" class="form-label">GPA/CGPA *</label>
                                            <input type="number" class="form-control" id="gpa" min="0" max="10" step="0.01" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="graduationYear" class="form-label">Graduation Year *</label>
                                            <input type="number" class="form-control" id="graduationYear" min="2020" max="2030" required>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="backlogCount" class="form-label">Backlog Count</label>
                                            <input type="number" class="form-control" id="backlogCount" min="0" value="0">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="conduct" class="form-label">Conduct</label>
                                            <select class="form-select" id="conduct">
                                                <option value="">Select</option>
                                                <option value="poor">Poor</option>
                                                <option value="average">Average</option>
                                                <option value="good">Good</option>
                                                <option value="outstanding">Outstanding</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="backlogs" class="form-label">Backlog Courses (if any)</label>
                                        <textarea class="form-control" id="backlogs" rows="2" 
                                                  placeholder="Enter backlog courses separated by commas"></textarea>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="courses" class="form-label">Completed Courses</label>
                                        <textarea class="form-control" id="courses" rows="3" 
                                                  placeholder="Enter courses separated by commas"></textarea>
                                    </div>
                                    
                                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                        <button type="button" class="btn btn-secondary me-md-2" onclick="clearForm()">
                                            <i class="fas fa-undo me-1"></i>Clear
                                        </button>
                                        <button type="submit" class="btn btn-primary" id="issueBtn">
                                            <i class="fas fa-certificate me-1"></i>Issue Credential
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h6><i class="fas fa-info-circle me-2"></i>Process Steps</h6>
                            </div>
                            <div class="card-body">
                                <ol class="list-group list-group-numbered list-group-flush">
                                    <li class="list-group-item border-0 px-0">W3C Verifiable Credential</li>
                                    <li class="list-group-item border-0 px-0">RSA-2048 Signature</li>
                                    <li class="list-group-item border-0 px-0">IPFS Storage</li>
                                    <li class="list-group-item border-0 px-0">Blockchain Record</li>
                                    <li class="list-group-item border-0 px-0">Version Tracking</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION 2: Manage Credentials (UNCHANGED) -->
            <div id="manageSection" class="content-section" style="display:none;">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-list me-2"></i>All Issued Credentials</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="loadCredentials()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="credentialsTableContainer">
                            <p class="text-muted">Loading credentials...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION 3: Search Student (UNCHANGED) -->
            <div id="searchSection" class="content-section" style="display:none;">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-search me-2"></i>Search Student Credentials</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="searchStudentId" placeholder="Enter Roll Number (e.g., 229X1A2847)">
                                    <button class="btn btn-primary" onclick="searchByStudentId()">
                                        <i class="fas fa-search me-1"></i>Search
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="searchResults"></div>
                    </div>
                </div>
            </div>

            <!-- SECTION 4: Tickets (ENHANCED KANBAN) -->
            <div id="ticketsSection" class="content-section" style="display:none;">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-ticket-alt me-2"></i>Student Support Tickets</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="loadAdminTickets()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row" id="kanbanBoard">
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0"><i class="fas fa-inbox me-2"></i>Open</h6>
                                    </div>
                                    <div class="card-body" id="openColumn" style="min-height: 400px;">
                                        <p class="text-muted small">Loading...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="mb-0"><i class="fas fa-tasks me-2"></i>In Progress</h6>
                                    </div>
                                    <div class="card-body" id="inProgressColumn" style="min-height: 400px;">
                                        <p class="text-muted small">Loading...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>Resolved</h6>
                                    </div>
                                    <div class="card-body" id="resolvedColumn" style="min-height: 400px;">
                                        <p class="text-muted small">Loading...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION 5: Messages (ENHANCED WITH REVOCATION) -->
            <div id="messagesSection" class="content-section" style="display:none;">
                <div class="row">
                    <div class="col-md-5">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-paper-plane me-2"></i>Send Message</h5>
                            </div>
                            <div class="card-body">
                                <form id="sendMessageForm">
                                    <div class="mb-3">
                                        <label class="form-label">Recipient Type</label>
                                        <select class="form-select" id="messageType" onchange="toggleRecipientField()">
                                            <option value="individual">Individual Student</option>
                                            <option value="broadcast">Broadcast to All Students</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3" id="recipientField">
                                        <label for="toStudentId" class="form-label">Student Roll Number</label>
                                        <input type="text" class="form-control" id="toStudentId" placeholder="e.g., 229X1A2847">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="messageSubject" class="form-label">Subject *</label>
                                        <input type="text" class="form-control" id="messageSubject" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="messageBody" class="form-label">Message *</label>
                                        <textarea class="form-control" id="messageBody" rows="5" required></textarea>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-paper-plane me-1"></i>Send Message
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-7">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5><i class="fas fa-history me-2"></i>Sent Messages</h5>
                                <button class="btn btn-sm btn-outline-secondary" onclick="loadAdminMessages()">
                                    <i class="fas fa-sync-alt me-1"></i>Refresh
                                </button>
                            </div>
                            <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                                <div id="sentMessages">
                                    <p class="text-muted">Loading messages...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Success Modal (UNCHANGED) -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>Credential Issued Successfully
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="credentialDetails"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="issueAnother()">Issue Another</button>
            </div>
        </div>
    </div>
</div>

<!-- Revoke Modal (UNCHANGED) -->
<div class="modal fade" id="revokeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="fas fa-ban me-2"></i>Revoke Credential
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to revoke this credential?</p>
                <p class="text-muted small">Revoked credentials remain on blockchain but become invalid.</p>
                
                <div class="mb-3">
                    <label for="revokeReason" class="form-label">Reason for Revocation *</label>
                    <select class="form-select" id="revokeReasonCategory">
                        <option value="duplicate">Duplicate Credential</option>
                        <option value="misconduct">Student Misconduct</option>
                        <option value="legal">Legal Requirement</option>
                        <option value="request">Student Request</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="revokeReasonText" class="form-label">Additional Details</label>
                    <textarea class="form-control" id="revokeReasonText" rows="3"></textarea>
                </div>
                
                <input type="hidden" id="revokeCredentialId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmRevoke()">
                    <i class="fas fa-ban me-1"></i>Revoke Credential
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Ticket Details Modal (ENHANCED) -->
<div class="modal fade" id="ticketModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-ticket-alt me-2"></i>Ticket Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="ticketModalBody">
                <!-- Populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// ==================== SECTION NAVIGATION (UNCHANGED) ====================
function showSection(section) {
    document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    
    const sectionMap = {
        'issue': { id: 'issueSection', title: 'Issue New Credential', icon: 'fa-plus-circle' },
        'manage': { id: 'manageSection', title: 'Manage Credentials', icon: 'fa-list' },
        'search': { id: 'searchSection', title: 'Search Student', icon: 'fa-search' },
        'tickets': { id: 'ticketsSection', title: 'Student Tickets', icon: 'fa-ticket-alt' },
        'messages': { id: 'messagesSection', title: 'Messages', icon: 'fa-envelope' }
    };
    
    const selected = sectionMap[section];
    document.getElementById(selected.id).style.display = 'block';
    document.getElementById('sectionTitle').innerHTML = `<i class="fas ${selected.icon} text-primary me-2"></i>${selected.title}`;
    
    event.target.classList.add('active');
    
    if (section === 'manage') loadCredentials();
    if (section === 'tickets') loadAdminTickets();
    if (section === 'messages') loadAdminMessages();
}

// ==================== CREDENTIAL ISSUING (UNCHANGED) ====================
document.getElementById('issueCredentialForm').addEventListener('submit', function(e) {
    e.preventDefault();
    issueCredential();
});

function issueCredential() {
    const issueBtn = document.getElementById('issueBtn');
    const originalText = issueBtn.innerHTML;
    issueBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Issuing...';
    issueBtn.disabled = true;
    
    const formData = {
        student_name: document.getElementById('studentName').value,
        student_id: document.getElementById('studentId').value,
        degree: document.getElementById('degree').value,
        university: document.getElementById('university').value,
        gpa: parseFloat(document.getElementById('gpa').value),
        graduation_year: parseInt(document.getElementById('graduationYear').value),
        courses: document.getElementById('courses').value.split(',').map(c => c.trim()).filter(c => c),
        semester: document.getElementById('semester').value ? parseInt(document.getElementById('semester').value) : null,
        year: document.getElementById('year').value || null,
        class_name: document.getElementById('className').value || null,
        section: document.getElementById('section').value || null,
        backlog_count: parseInt(document.getElementById('backlogCount').value || 0),
        backlogs: document.getElementById('backlogs').value.split(',').map(c => c.trim()).filter(c => c),
        conduct: document.getElementById('conduct').value || null
    };
    
    fetch('/api/issue_credential', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessModal(data);
            clearForm();
            loadDashboardData();
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Network error occurred', 'danger');
    })
    .finally(() => {
        issueBtn.innerHTML = originalText;
        issueBtn.disabled = false;
    });
}

function showSuccessModal(data) {
    const credentialDetails = document.getElementById('credentialDetails');
    credentialDetails.innerHTML = `
        <div class="row">
            <div class="col-12">
                <h6>‚úÖ Credential Issued Successfully</h6>
                <table class="table table-sm table-bordered">
                    <tr class="table-primary">
                        <td colspan="2"><strong>üÜî IDENTITY</strong></td>
                    </tr>
                    <tr>
                        <td><strong>Credential ID:</strong></td>
                        <td><code>${data.credential_id}</code></td>
                    </tr>
                    <tr>
                        <td><strong>Version:</strong></td>
                        <td><span class="badge bg-primary">v${data.version || 1}</span></td>
                    </tr>
                    <tr>
                        <td><strong>Issuer ID:</strong></td>
                        <td><code>did:edu:gprec</code></td>
                    </tr>
                    
                    <tr class="table-warning">
                        <td colspan="2"><strong>üîê CRYPTOGRAPHIC PROOFS</strong></td>
                    </tr>
                    <tr>
                        <td><strong>Credential Hash:</strong></td>
                        <td><code class="small">${data.credential_hash ? data.credential_hash.substring(0, 32) + '...' : 'N/A'}</code></td>
                    </tr>
                    <tr>
                        <td><strong>Digital Signature:</strong></td>
                        <td><span class="badge bg-success">‚úì RSA-2048 Signed</span></td>
                    </tr>
                    
                    <tr class="table-info">
                        <td colspan="2"><strong>üíæ STORAGE & BLOCKCHAIN</strong></td>
                    </tr>
                    <tr>
                        <td><strong>IPFS CID:</strong></td>
                        <td><code>${data.ipfs_cid}</code></td>
                    </tr>
                    <tr>
                        <td><strong>Transaction Hash:</strong></td>
                        <td><code class="small">${data.tx_hash ? data.tx_hash.substring(0, 32) + '...' : data.transaction_id ? data.transaction_id.substring(0, 32) + '...' : 'N/A'}</code></td>
                    </tr>
                    <tr>
                        <td><strong>Block Hash:</strong></td>
                        <td><code class="small">${data.block_hash.substring(0, 32)}...</code></td>
                    </tr>
                    <tr>
                        <td><strong>Block Number:</strong></td>
                        <td><span class="badge bg-secondary">#${data.block_number}</span></td>
                    </tr>
                    <tr>
                        <td><strong>Network:</strong></td>
                        <td><span class="badge bg-dark">local-dev-chain</span></td>
                    </tr>
                    
                    <tr class="table-success">
                        <td colspan="2"><strong>üîÅ VERSIONING & LIFECYCLE</strong></td>
                    </tr>
                    <tr>
                        <td><strong>Status:</strong></td>
                        <td><span class="badge bg-success">ACTIVE</span></td>
                    </tr>
                    ${data.superseded_count > 0 ? `
                    <tr>
                        <td><strong>Superseded:</strong></td>
                        <td><span class="badge bg-warning text-dark">${data.superseded_count} previous version(s) marked as SUPERSEDED</span></td>
                    </tr>
                    ` : ''}
                    <tr>
                        <td><strong>Schema:</strong></td>
                        <td><code>AcademicTranscriptCredential v1.0</code></td>
                    </tr>
                </table>
                
                <div class="alert alert-info small mb-0">
                    <strong>‚ÑπÔ∏è Complete Metadata Generated:</strong><br>
                    ‚Ä¢ Issuer DID: <code>did:edu:gprec</code><br>
                    ‚Ä¢ Holder DID: <code>did:edu:gprec:student:${data.student_id || '...'}</code><br>
                    ‚Ä¢ SHA-256 Hash: ‚úì Computed<br>
                    ‚Ä¢ RSA Signature: ‚úì Applied<br>
                    ‚Ä¢ Transaction Reference: ‚úì Recorded<br>
                    ‚Ä¢ Lifecycle State: ‚úì Tracked<br>
                    ${data.superseded_count > 0 ? `‚Ä¢ Auto-Superseded ${data.superseded_count} old credential(s)` : ''}
                </div>
            </div>
        </div>
    `;
    
        // Add to page instead of modal
    const container = document.getElementById('issueSection');
    const existingSuccess = document.getElementById('inlineSuccess');
    if (existingSuccess) existingSuccess.remove();
    
    const successDiv = document.createElement('div');
    successDiv.id = 'inlineSuccess';
    successDiv.className = 'mt-4';
    successDiv.innerHTML = `
        <div class="alert alert-success alert-dismissible">
            <h5>‚úÖ Credential Issued Successfully</h5>
            <button class="btn-close" onclick="document.getElementById('inlineSuccess').remove()"></button>
        </div>
        ${credentialDetails.innerHTML}
        <button class="btn btn-primary mt-3" onclick="issueAnother()">Issue Another</button>
    `;
    container.appendChild(successDiv);
    successDiv.scrollIntoView({ behavior: 'smooth' });
}


function clearForm() {
    document.getElementById('issueCredentialForm').reset();
    document.getElementById('university').value = 'G. Pulla Reddy Engineering College';
    document.getElementById('backlogCount').value = '0';
}

function issueAnother() {
    const elem = document.getElementById('inlineSuccess');
    if (elem) elem.remove();
    clearForm();
}


// ==================== MANAGE CREDENTIALS (UNCHANGED) ====================
function loadCredentials() {
    const container = document.getElementById('credentialsTableContainer');
    container.innerHTML = '<p class="text-muted">Loading credentials...</p>';

    fetch('/api/credentials')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.credentials.length === 0) {
                    container.innerHTML = '<p class="text-muted">No credentials found.</p>';
                    return;
                }

                let html = `<div class="table-responsive"><table class="table table-sm table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Student</th>
                            <th>Roll No</th>
                            <th>Version</th>
                            <th>Status</th>
                            <th>GPA</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>`;

                data.credentials.forEach(c => {
                    const statusBadge = c.status === 'active' ? '<span class="badge bg-success">ACTIVE</span>' :
                                       c.status === 'revoked' ? '<span class="badge bg-danger">REVOKED</span>' :
                                       '<span class="badge bg-secondary">SUPERSEDED</span>';
                    
                    html += `
                        <tr>
                            <td><code class="small">${c.credential_id.slice(-8)}</code></td>
                            <td>${c.student_name || ''}</td>
                            <td><code>${c.student_id || ''}</code></td>
                            <td><span class="badge bg-primary">v${c.version || 1}</span></td>
                            <td>${statusBadge}</td>
                            <td>${c.gpa ? c.gpa.toFixed(2) : '-'}</td>
                            <td>${c.issue_date ? new Date(c.issue_date).toLocaleDateString() : ''}</td>
                            <td>
                                ${c.status === 'active' ? `
                                <button class="btn btn-sm btn-outline-danger" onclick="showRevokeModal('${c.credential_id}')">
                                    <i class="fas fa-ban"></i> Revoke
                                </button>
                                ` : '<span class="text-muted small">N/A</span>'}
                            </td>
                        </tr>`;
                });

                html += `</tbody></table></div>`;
                container.innerHTML = html;
            } else {
                container.innerHTML = '<p class="text-danger">Could not load credentials</p>';
            }
        })
        .catch(err => {
            console.error('Error loading credentials:', err);
            container.innerHTML = '<p class="text-danger">Network error loading credentials</p>';
        });
}

function showRevokeModal(credentialId) {
    document.getElementById('revokeCredentialId').value = credentialId;
    const modal = new bootstrap.Modal(document.getElementById('revokeModal'));
    modal.show();
}

function confirmRevoke() {
    const credentialId = document.getElementById('revokeCredentialId').value;
    const reason = document.getElementById('revokeReasonText').value;
    const category = document.getElementById('revokeReasonCategory').value;
    
    fetch('/api/revoke_credential', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            credential_id: credentialId,
            reason: reason,
            reason_category: category
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Credential revoked successfully', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('revokeModal'));
            modal.hide();
            loadCredentials();
            loadDashboardData();
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(err => {
        console.error('Revoke error:', err);
        showAlert('Network error while revoking credential', 'danger');
    });
}

// ==================== SEARCH (UNCHANGED) ====================
function searchByStudentId() {
    const studentId = document.getElementById('searchStudentId').value.trim();
    if (!studentId) {
        showAlert('Please enter a roll number', 'warning');
        return;
    }
    
    const resultsDiv = document.getElementById('searchResults');
    resultsDiv.innerHTML = '<p class="text-muted">Searching...</p>';
    
    fetch(`/api/credential_history/${studentId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.credentials.length > 0) {
                let html = `
                    <h6>Found ${data.total_versions} version(s) for ${studentId}</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Version</th>
                                    <th>Status</th>
                                    <th>GPA</th>
                                    <th>Sem/Yr</th>
                                    <th>Issued</th>
                                    <th>ID</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.credentials.forEach(c => {
                    const statusBadge = c.status === 'active' ? '<span class="badge bg-success">ACTIVE</span>' :
                                       c.status === 'revoked' ? '<span class="badge bg-danger">REVOKED</span>' :
                                       '<span class="badge bg-secondary">SUPERSEDED</span>';
                    const semYear = c.semester ? `Sem ${c.semester}/${c.year || '-'}` : '-';
                    
                    html += `
                        <tr>
                            <td><span class="badge bg-primary">v${c.version}</span></td>
                            <td>${statusBadge}</td>
                            <td>${c.gpa ? c.gpa.toFixed(2) : '-'}</td>
                            <td>${semYear}</td>
                            <td>${c.issued_at ? new Date(c.issued_at).toLocaleDateString() : '-'}</td>
                            <td><code class="small">${c.credential_id.slice(-8)}</code></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="viewFullCredentialDetails('${c.credential_id}')">
                                    <i class="fas fa-eye me-1"></i>View
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `</tbody></table></div>`;
                resultsDiv.innerHTML = html;
            } else {
                resultsDiv.innerHTML = '<div class="alert alert-warning">No credentials found for this student.</div>';
            }
        })
        .catch(err => {
            console.error('Search error:', err);
            resultsDiv.innerHTML = '<div class="alert alert-danger">Search error occurred</div>';
        });
}
// ==================== TICKET MANAGEMENT (ENHANCED) ====================
function loadAdminTickets() {
    fetch('/api/tickets')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const tickets = data.tickets;
                const open = tickets.filter(t => t.status === 'open');
                const inProgress = tickets.filter(t => t.status === 'in_progress');
                const resolved = tickets.filter(t => t.status === 'resolved');
                
                document.getElementById('openColumn').innerHTML = renderAdminTickets(open, 'open');
                document.getElementById('inProgressColumn').innerHTML = renderAdminTickets(inProgress, 'in_progress');
                document.getElementById('resolvedColumn').innerHTML = renderAdminTickets(resolved, 'resolved');
                
                document.getElementById('ticketBadge').textContent = open.length + inProgress.length;
                document.getElementById('pendingTicketsBadge').textContent = open.length;
            } else {
                console.error('Error loading tickets:', data.error);
            }
        })
        .catch(err => {
            console.error('Error loading tickets:', err);
            document.getElementById('openColumn').innerHTML = '<p class="text-danger small">Error loading tickets</p>';
        });
}


function renderAdminTickets(tickets, status) {
    if (tickets.length === 0) return '<p class="text-muted small">No tickets</p>';
    
    let html = '';
    tickets.forEach(t => {
        const priorityColor = t.priority === 'high' ? 'danger' : t.priority === 'medium' ? 'warning' : 'secondary';
        html += `
            <div class="card mb-2 admin-ticket-card" onclick="viewAdminTicket('${t.ticket_id}')">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                        <h6 class="card-title mb-0 small">${t.subject}</h6>
                        <span class="badge bg-${priorityColor} badge-sm">${t.priority}</span>
                    </div>
                    <p class="card-text small text-muted mb-1">
                        <i class="fas fa-user me-1"></i>${t.student_id}
                    </p>
                    <p class="card-text small text-muted mb-1">
                        <i class="fas fa-tag me-1"></i>${t.category}
                    </p>
                    <small class="text-muted">#${t.ticket_id}</small>
                </div>
            </div>
        `;
    });
    return html;
}

function viewAdminTicket(ticketId) {
    fetch(`/api/tickets/${ticketId}`)
        .then(response => response.json())
        .then(data => {
            if (data.ticket) {
                const ticket = data.ticket;
                let responsesHtml = '';
                
                if (ticket.responses && ticket.responses.length > 0) {
                    responsesHtml = '<hr><h6>Conversation History:</h6>';
                    ticket.responses.forEach(r => {
                        const badge = r.responder === 'admin' ? '<span class="badge bg-primary">Admin</span>' : '<span class="badge bg-info">Student</span>';
                        responsesHtml += `
                            <div class="mb-2 p-2 ${r.responder === 'admin' ? 'bg-light' : 'bg-info bg-opacity-10'} rounded">
                                <div class="d-flex justify-content-between">
                                    ${badge}
                                    <small class="text-muted">${new Date(r.timestamp).toLocaleString()}</small>
                                </div>
                                <p class="mb-1 mt-1">${r.message}</p>
                                ${r.action ? `<small class="text-info"><i class="fas fa-info-circle me-1"></i>${r.action}</small>` : ''}
                            </div>
                        `;
                    });
                }
                
                document.getElementById('ticketModalBody').innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Ticket ID:</strong> #${ticket.ticket_id}</p>
                            <p><strong>Student:</strong> ${ticket.student_id}</p>
                            <p><strong>Category:</strong> <span class="badge bg-secondary">${ticket.category}</span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Priority:</strong> <span class="badge bg-warning">${ticket.priority}</span></p>
                            <p><strong>Status:</strong> <span class="badge bg-info">${ticket.status}</span></p>
                            <p><strong>Created:</strong> ${new Date(ticket.created_at).toLocaleString()}</p>
                        </div>
                    </div>
                    <hr>
                    <h6>Subject:</h6>
                    <p>${ticket.subject}</p>
                    <h6>Description:</h6>
                    <p>${ticket.description}</p>
                    ${responsesHtml}
                    <hr>
                    <h6>Admin Actions:</h6>
                    <div class="btn-group w-100 mb-2">
                        <button class="btn btn-info" onclick="adminMoveTicket('${ticket.ticket_id}', 'open')">
                            <i class="fas fa-inbox me-1"></i>Open
                        </button>
                        <button class="btn btn-warning" onclick="adminMoveTicket('${ticket.ticket_id}', 'in_progress')">
                            <i class="fas fa-tasks me-1"></i>In Progress
                        </button>
                        <button class="btn btn-success" onclick="adminMoveTicket('${ticket.ticket_id}', 'resolved')">
                            <i class="fas fa-check me-1"></i>Resolved
                        </button>
                    </div>
                    <div class="input-group mt-2">
                        <input type="text" class="form-control" id="adminNoteInput" placeholder="Add a note...">
                        <button class="btn btn-primary" onclick="adminAddNote('${ticket.ticket_id}')">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div>
                `;
                
                const modal = new bootstrap.Modal(document.getElementById('ticketModal'));
                modal.show();
            }
        });
}

function adminMoveTicket(ticketId, newStatus) {
    const note = document.getElementById('adminNoteInput').value || `Ticket moved to ${newStatus}`;
    
    fetch(`/api/tickets/${ticketId}/status`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            status: newStatus,
            admin_note: note,
            by_admin: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`Ticket moved to ${newStatus}`, 'success');
            loadAdminTickets();
            const modal = bootstrap.Modal.getInstance(document.getElementById('ticketModal'));
            if (modal) modal.hide();
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    });
}

function adminAddNote(ticketId) {
    const note = document.getElementById('adminNoteInput').value;
    if (!note.trim()) return;
    
    fetch(`/api/tickets/${ticketId}/response`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            responder: 'admin',
            message: note
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Note added', 'success');
            viewAdminTicket(ticketId); // Refresh
        }
    });
}

// ==================== MESSAGE MANAGEMENT (ENHANCED) ====================
document.getElementById('sendMessageForm').addEventListener('submit', function(e) {
    e.preventDefault();
    sendAdminMessage();
});

function toggleRecipientField() {
    const messageType = document.getElementById('messageType').value;
    const recipientField = document.getElementById('recipientField');
    recipientField.style.display = messageType === 'individual' ? 'block' : 'none';
}

function sendAdminMessage() {
    const messageType = document.getElementById('messageType').value;
    const subject = document.getElementById('messageSubject').value;
    const message = document.getElementById('messageBody').value;
    
    if (messageType === 'individual') {
        const toStudentId = document.getElementById('toStudentId').value.trim();
        if (!toStudentId) {
            showAlert('Please enter student roll number', 'warning');
            return;
        }
        
        fetch('/api/messages', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                sender_id: 'admin',
                sender_type: 'admin',
                recipient_id: toStudentId,
                recipient_type: 'student',
                subject: subject,
                message: message
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Message sent successfully', 'success');
                document.getElementById('sendMessageForm').reset();
                loadAdminMessages();
            } else {
                showAlert('Error: ' + data.error, 'danger');
            }
        });
    } else {
        fetch('/api/messages/broadcast', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                sender_id: 'admin',
                subject: subject,
                message: message
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Broadcast message sent to all students!', 'success');
                document.getElementById('sendMessageForm').reset();
                loadAdminMessages();
            } else {
                showAlert('Error: ' + data.error, 'danger');
            }
        });
    }
}

function loadAdminMessages() {
    fetch('/api/messages/all')
        .then(response => response.json())
        .then(data => {
            displayAdminMessages(data.messages || []);
        })
        .catch(err => {
            console.error('Error loading messages:', err);
            document.getElementById('sentMessages').innerHTML = '<p class="text-danger">Error loading messages</p>';
        });
}

function displayAdminMessages(messages) {
    const container = document.getElementById('sentMessages');
    
    if (messages.length === 0) {
        container.innerHTML = '<p class="text-muted">No messages sent yet</p>';
        return;
    }
    
    container.innerHTML = messages.map(msg => {
        const isRevoked = msg.revoked;
        const isBroadcast = msg.is_broadcast;
        
        return `
            <div class="card mb-2 ${isRevoked ? 'border-danger' : ''}">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1 ${isRevoked ? 'text-decoration-line-through text-muted' : ''}">
                                ${isBroadcast ? 'üì¢ BROADCAST' : 'üì© To: ' + msg.recipient_id}
                            </h6>
                            <p class="mb-1 small ${isRevoked ? 'text-decoration-line-through text-muted' : ''}">
                                <strong>${msg.subject}</strong>
                            </p>
                            <p class="mb-1 small text-muted ${isRevoked ? 'text-decoration-line-through' : ''}">
                                ${msg.message.substring(0, 80)}${msg.message.length > 80 ? '...' : ''}
                            </p>
                        </div>
                        <div class="text-end">
                            ${isRevoked ? 
                                `<span class="badge bg-danger mb-1">REVOKED</span><br>
                                <small class="text-muted">${new Date(msg.revoked_at).toLocaleString()}</small>` 
                            : 
                                `<button class="btn btn-sm btn-outline-danger" onclick="revokeMessage('${msg.message_id}')">
                                    <i class="fas fa-ban"></i> Revoke
                                </button>`
                            }
                        </div>
                    </div>
                    <small class="text-muted">Sent: ${new Date(msg.timestamp).toLocaleString()}</small>
                </div>
            </div>
        `;
    }).join('');
}

function revokeMessage(messageId) {
    if (!confirm('Are you sure you want to revoke this message? It will appear as strikethrough for all recipients.')) return;
    
    fetch(`/api/messages/${messageId}/revoke`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ admin_id: 'admin' })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Message revoked successfully', 'success');
            loadAdminMessages();
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    });
}

// ==================== DASHBOARD & UTILITIES ====================
function loadDashboardData() {
    fetch('/api/credentials')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('totalCredsBadge').textContent = data.credentials.length;
            }
        });
    
    loadAdminTickets();
}

function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3" style="z-index: 9999; min-width: 300px; max-width: 600px;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', alertHtml);
    setTimeout(() => {
        const alert = document.querySelector('.alert');
        if (alert) alert.remove();
    }, 5000);
}

// Load on page load
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
});
function viewFullCredentialDetails(credentialId) {
    const detailsDiv = document.getElementById('fullCredentialDetails');
    detailsDiv.innerHTML = '<p class="text-muted">Loading credential details...</p>';
    
    // Show modal immediately
    const modal = new bootstrap.Modal(document.getElementById('fullCredentialModal'));
    modal.show();
    
    // Fetch full credential data
    fetch(`/api/get_credential/${credentialId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.credential) {
                const cred = data.credential;
                const fullCred = cred.full_credential;
                const subject = fullCred ? fullCred.credentialSubject : {};
                
                detailsDiv.innerHTML = `
                    <div class="alert alert-info mb-3">
                        <strong><i class="fas fa-info-circle me-2"></i>Complete Metadata Generated:</strong><br>
                        ‚Ä¢ Issuer DID: <code>did:edu:gprec</code><br>
                        ‚Ä¢ Holder DID: <code>did:edu:gprec:student:${cred.student_id}</code><br>
                        ‚Ä¢ SHA-256 Hash: ‚úì Computed<br>
                        ‚Ä¢ RSA Signature: ‚úì Applied<br>
                        ‚Ä¢ Transaction Reference: ‚úì Recorded<br>
                        ‚Ä¢ Lifecycle State: ‚úì Tracked<br>
                        ${cred.superseded_count > 0 ? `‚Ä¢ Auto-Superseded ${cred.superseded_count} old credential(s)` : ''}
                    </div>

                    <table class="table table-sm table-bordered">
                        <!-- IDENTITY -->
                        <tr class="table-primary">
                            <td colspan="2"><strong>üÜî IDENTITY</strong></td>
                        </tr>
                        <tr>
                            <td style="width: 30%;"><strong>Credential ID</strong></td>
                            <td><code>${cred.credential_id}</code></td>
                        </tr>
                        <tr>
                            <td><strong>Version</strong></td>
                            <td><span class="badge bg-primary">v${cred.version || 1}</span></td>
                        </tr>
                        <tr>
                            <td><strong>Issuer ID</strong></td>
                            <td><code>did:edu:gprec</code></td>
                        </tr>
                        
                        <!-- STUDENT INFORMATION -->
                        <tr class="table-light">
                            <td colspan="2"><strong>üë§ STUDENT INFORMATION</strong></td>
                        </tr>
                        <tr>
                            <td><strong>Name</strong></td>
                            <td>${subject.name || cred.student_name || '-'}</td>
                        </tr>
                        <tr>
                            <td><strong>Roll Number</strong></td>
                            <td><code>${subject.studentId || cred.student_id || '-'}</code></td>
                        </tr>
                        <tr>
                            <td><strong>Degree Program</strong></td>
                            <td>${subject.degree || cred.degree || '-'}</td>
                        </tr>
                        <tr>
                            <td><strong>University</strong></td>
                            <td>${subject.university || cred.university || '-'}</td>
                        </tr>
                        <tr>
                            <td><strong>GPA/CGPA</strong></td>
                            <td><strong>${subject.gpa || cred.gpa || '-'}</strong></td>
                        </tr>
                        <tr>
                            <td><strong>Graduation Year</strong></td>
                            <td>${subject.graduationYear || cred.graduation_year || '-'}</td>
                        </tr>
                        ${subject.semester ? `<tr><td><strong>Semester</strong></td><td>${subject.semester}</td></tr>` : ''}
                        ${subject.year ? `<tr><td><strong>Year</strong></td><td>${subject.year}</td></tr>` : ''}
                        ${subject.className ? `<tr><td><strong>Class</strong></td><td>${subject.className}</td></tr>` : ''}
                        ${subject.section ? `<tr><td><strong>Section</strong></td><td>${subject.section}</td></tr>` : ''}
                        ${subject.backlogCount !== undefined ? `<tr><td><strong>Backlog Count</strong></td><td>${subject.backlogCount}</td></tr>` : ''}
                        ${subject.conduct ? `<tr><td><strong>Conduct</strong></td><td><span class="badge bg-info">${subject.conduct}</span></td></tr>` : ''}
                        
                        <!-- CRYPTOGRAPHIC PROOFS -->
                        <tr class="table-warning">
                            <td colspan="2"><strong>üîê CRYPTOGRAPHIC PROOFS</strong></td>
                        </tr>
                        <tr>
                            <td><strong>Credential Hash</strong></td>
                            <td><code class="small">${cred.credential_hash ? cred.credential_hash.substring(0, 32) + '...' : 'N/A'}</code></td>
                        </tr>
                        <tr>
                            <td><strong>Digital Signature</strong></td>
                            <td><span class="badge bg-success">‚úì RSA-2048 Signed</span></td>
                        </tr>
                        
                        <!-- STORAGE & BLOCKCHAIN -->
                        <tr class="table-info">
                            <td colspan="2"><strong>üíæ STORAGE & BLOCKCHAIN</strong></td>
                        </tr>
                        <tr>
                            <td><strong>IPFS CID</strong></td>
                            <td><code>${cred.ipfs_cid}</code></td>
                        </tr>
                        <tr>
                            <td><strong>Transaction Hash</strong></td>
                            <td><code class="small">${cred.tx_hash ? cred.tx_hash.substring(0, 32) + '...' : cred.transaction_id ? cred.transaction_id.substring(0, 32) + '...' : 'N/A'}</code></td>
                        </tr>
                        <tr>
                            <td><strong>Block Hash</strong></td>
                            <td><code class="small">${cred.block_hash ? cred.block_hash.substring(0, 32) + '...' : 'N/A'}</code></td>
                        </tr>
                        <tr>
                            <td><strong>Block Number</strong></td>
                            <td><span class="badge bg-secondary">#${cred.block_number || 'N/A'}</span></td>
                        </tr>
                        <tr>
                            <td><strong>Network</strong></td>
                            <td><span class="badge bg-dark">local-dev-chain</span></td>
                        </tr>
                        
                        <!-- VERSIONING & LIFECYCLE -->
                        <tr class="table-success">
                            <td colspan="2"><strong>üîÅ VERSIONING & LIFECYCLE</strong></td>
                        </tr>
                        <tr>
                            <td><strong>Status</strong></td>
                            <td><span class="badge bg-${cred.status === 'active' ? 'success' : cred.status === 'revoked' ? 'danger' : 'secondary'}">${cred.status.toUpperCase()}</span></td>
                        </tr>
                        ${cred.superseded_count > 0 ? `
                        <tr>
                            <td><strong>Superseded</strong></td>
                            <td><span class="badge bg-warning text-dark">${cred.superseded_count} previous version(s) marked as SUPERSEDED</span></td>
                        </tr>
                        ` : ''}
                        <tr>
                            <td><strong>Schema</strong></td>
                            <td><code>AcademicTranscriptCredential v1.0</code></td>
                        </tr>
                        <tr>
                            <td><strong>Issue Date</strong></td>
                            <td>${cred.issue_date ? new Date(cred.issue_date).toLocaleString() : '-'}</td>
                        </tr>
                        ${cred.revoked_at ? `
                        <tr>
                            <td><strong>Revoked At</strong></td>
                            <td><span class="text-danger">${new Date(cred.revoked_at).toLocaleString()}</span></td>
                        </tr>
                        ` : ''}
                        ${cred.revoke_reason ? `
                        <tr>
                            <td><strong>Revocation Reason</strong></td>
                            <td>${cred.revoke_reason}</td>
                        </tr>
                        ` : ''}
                    </table>
                    
                    ${subject.courses && subject.courses.length > 0 ? `
                        <div class="mt-3">
                            <h6>üìö Completed Courses (${subject.courses.length})</h6>
                            <div class="row">
                                ${subject.courses.map(course => `<div class="col-md-4 mb-2"><span class="badge bg-info">${course}</span></div>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${subject.backlogs && subject.backlogs.length > 0 ? `
                        <div class="mt-3">
                            <h6>‚ö†Ô∏è Backlog Courses (${subject.backlogs.length})</h6>
                            <div class="row">
                                ${subject.backlogs.map(course => `<div class="col-md-4 mb-2"><span class="badge bg-warning text-dark">${course}</span></div>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                `;
            } else {
                detailsDiv.innerHTML = '<div class="alert alert-danger">Failed to load credential details</div>';
            }
        })
        .catch(err => {
            console.error('Error loading credential:', err);
            detailsDiv.innerHTML = '<div class="alert alert-danger">Network error loading credential details</div>';
        });
}
</script>

<style>
.sidebar {
    position: fixed;
    top: 56px;
    bottom: 0;
    left: 0;
    z-index: 100;
    padding: 0;
    box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
    overflow-y: auto;
}

.sidebar .nav-link {
    font-weight: 700;
    color: #1a1a1a;
    padding: 0.75rem 1rem;
    font-size: 0.95rem;
}

.sidebar .nav-link.active {
    font-weight: 800;
    color: #0d6efd;
    background-color: #e7f1ff;
}

.sidebar .nav-link:hover {
    color: #0d6efd;
    background-color: #f8f9fa;
    font-weight: 700;
}

.sidebar h6 {
    font-weight: 700;
    color: #1a1a1a;
}

.sidebar .user-name-bold {
    font-weight: 900 !important;
    color: #000000 !important;
    font-size: 0.9rem;
    display: block;
}

.sidebar .stats-header-bold {
    font-weight: 900 !important;
    color: #000000 !important;
    font-size: 0.875rem;
    display: block;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.sidebar .px-3 .small {
    font-weight: 600;
    color: #2c3e50;
}

.admin-ticket-card {
    cursor: pointer;
    transition: all 0.2s;
    border-left: 4px solid #007bff;
}

.admin-ticket-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

main {
    padding-top: 20px;
}
</style>
<!-- Full Credential Details Modal -->
<div class="modal fade" id="fullCredentialModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-certificate me-2"></i>Complete Credential Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="fullCredentialDetails">
                    <p class="text-muted">Loading...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
