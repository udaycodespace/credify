{% extends "base.html" %}

{% block title %}Issuer - Academic Institution{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <!-- Sidebar -->
<nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
    <div class="position-sticky pt-3">
        <div class="text-center mb-3">
            <i class="fas fa-university fa-3x text-primary"></i>
            <h6 class="mt-2">Issuer Portal</h6>
            <small class="user-name-bold">{{ session.full_name }}</small>
        </div>
        
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link active" href="#" onclick="showSection('issue'); return false;">
                    <i class="fas fa-plus-circle me-2"></i>Issue Credential
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="showSection('manage'); return false;">
                    <i class="fas fa-list me-2"></i>Manage Credentials
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="showSection('search'); return false;">
                    <i class="fas fa-search me-2"></i>Search Student
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="showSection('tickets'); return false;">
                    <i class="fas fa-ticket-alt me-2"></i>Tickets
                    <span class="badge bg-warning text-dark" id="ticketBadge">0</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="showSection('messages'); return false;">
                    <i class="fas fa-envelope me-2"></i>Messages
                </a>
            </li>
        </ul>
        
        <hr>
        
        <div class="px-3">
            <small class="stats-header-bold">Quick Stats</small>
            <div class="mt-2">
                <div class="d-flex justify-content-between">
                    <span class="small">Total Issued:</span>
                    <span class="badge bg-primary" id="totalCredsBadge">0</span>
                </div>
                <div class="d-flex justify-content-between mt-1">
                    <span class="small">Pending Tickets:</span>
                    <span class="badge bg-warning text-dark" id="pendingTicketsBadge">0</span>
                </div>
            </div>
        </div>
    </div>
</nav>

        <!-- Main content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h2 id="sectionTitle"><i class="fas fa-plus-circle text-primary me-2"></i>Issue New Credential</h2>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="loadDashboardData()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>
            </div>

            <!-- SECTION 1: Issue Credential -->
            <div id="issueSection" class="content-section">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-certificate me-2"></i>New Credential Form</h5>
                            </div>
                            <div class="card-body">
                                <form id="issueCredentialForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="studentName" class="form-label">Student Name *</label>
                                            <input type="text" class="form-control" id="studentName" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="studentId" class="form-label">Roll Number *</label>
                                            <input type="text" class="form-control" id="studentId" required>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="degree" class="form-label">Degree Program *</label>
                                            <select class="form-select" id="degree" required>
                                                <option value="">Select Degree</option>
                                                <option value="B.Tech Computer Science">B.Tech Computer Science</option>
                                                <option value="B.Tech Electronics">B.Tech Electronics</option>
                                                <option value="B.Tech Mechanical">B.Tech Mechanical</option>
                                                <option value="B.Tech Civil">B.Tech Civil</option>
                                                <option value="M.Tech Computer Science">M.Tech Computer Science</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="university" class="form-label">University *</label>
                                            <input type="text" class="form-control" id="university" value="G. Pulla Reddy Engineering College" required>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-3 mb-3">
                                            <label for="semester" class="form-label">Semester</label>
                                            <select class="form-select" id="semester">
                                                <option value="">Select</option>
                                                {% for i in range(1,9) %}
                                                <option value="{{ i }}">{{ i }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label for="year" class="form-label">Year</label>
                                            <select class="form-select" id="year">
                                                <option value="">Select</option>
                                                <option value="1">I Year</option>
                                                <option value="2">II Year</option>
                                                <option value="3">III Year</option>
                                                <option value="4">IV Year</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label for="className" class="form-label">Class</label>
                                            <input type="text" class="form-control" id="className" placeholder="e.g., B.Tech">
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label for="section" class="form-label">Section</label>
                                            <input type="text" class="form-control" id="section" placeholder="e.g., A/B">
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="gpa" class="form-label">GPA/CGPA *</label>
                                            <input type="number" class="form-control" id="gpa" min="0" max="10" step="0.01" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="graduationYear" class="form-label">Graduation Year *</label>
                                            <input type="number" class="form-control" id="graduationYear" min="2020" max="2030" required>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="backlogCount" class="form-label">Backlog Count</label>
                                            <input type="number" class="form-control" id="backlogCount" min="0" value="0">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="conduct" class="form-label">Conduct</label>
                                            <select class="form-select" id="conduct">
                                                <option value="">Select</option>
                                                <option value="poor">Poor</option>
                                                <option value="average">Average</option>
                                                <option value="good">Good</option>
                                                <option value="outstanding">Outstanding</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="backlogs" class="form-label">Backlog Courses (if any)</label>
                                        <textarea class="form-control" id="backlogs" rows="2" 
                                                  placeholder="Enter backlog courses separated by commas"></textarea>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="courses" class="form-label">Completed Courses</label>
                                        <textarea class="form-control" id="courses" rows="3" 
                                                  placeholder="Enter courses separated by commas"></textarea>
                                    </div>
                                    
                                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                        <button type="button" class="btn btn-secondary me-md-2" onclick="clearForm()">
                                            <i class="fas fa-undo me-1"></i>Clear
                                        </button>
                                        <button type="submit" class="btn btn-primary" id="issueBtn">
                                            <i class="fas fa-certificate me-1"></i>Issue Credential
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h6><i class="fas fa-info-circle me-2"></i>Process Steps</h6>
                            </div>
                            <div class="card-body">
                                <ol class="list-group list-group-numbered list-group-flush">
                                    <li class="list-group-item border-0 px-0">W3C Verifiable Credential</li>
                                    <li class="list-group-item border-0 px-0">RSA-2048 Signature</li>
                                    <li class="list-group-item border-0 px-0">IPFS Storage</li>
                                    <li class="list-group-item border-0 px-0">Blockchain Record</li>
                                    <li class="list-group-item border-0 px-0">Version Tracking</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION 2: Manage Credentials -->
            <div id="manageSection" class="content-section" style="display:none;">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-list me-2"></i>All Issued Credentials</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="loadCredentials()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="credentialsTableContainer">
                            <p class="text-muted">Loading credentials...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION 3: Search Student -->
            <div id="searchSection" class="content-section" style="display:none;">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-search me-2"></i>Search Student Credentials</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="searchStudentId" placeholder="Enter Roll Number (e.g., 229X1A2847)">
                                    <button class="btn btn-primary" onclick="searchByStudentId()">
                                        <i class="fas fa-search me-1"></i>Search
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="searchResults"></div>
                    </div>
                </div>
            </div>

            <!-- SECTION 4: Tickets (Kanban Board) -->
            <div id="ticketsSection" class="content-section" style="display:none;">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-ticket-alt me-2"></i>Student Tickets</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="loadTickets()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row" id="kanbanBoard">
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="mb-0"><i class="fas fa-inbox me-2"></i>To Do</h6>
                                    </div>
                                    <div class="card-body" id="todoColumn" style="min-height: 300px;">
                                        <p class="text-muted small">Loading...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0"><i class="fas fa-tasks me-2"></i>In Progress</h6>
                                    </div>
                                    <div class="card-body" id="inProgressColumn" style="min-height: 300px;">
                                        <p class="text-muted small">Loading...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>Completed</h6>
                                    </div>
                                    <div class="card-body" id="completedColumn" style="min-height: 300px;">
                                        <p class="text-muted small">Loading...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION 5: Messages -->
            <div id="messagesSection" class="content-section" style="display:none;">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-paper-plane me-2"></i>Send Message</h5>
                            </div>
                            <div class="card-body">
                                <form id="sendMessageForm">
                                    <div class="mb-3">
                                        <label class="form-label">Recipient Type</label>
                                        <select class="form-select" id="messageType" onchange="toggleRecipientField()">
                                            <option value="individual">Individual Student</option>
                                            <option value="broadcast">Broadcast to All</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3" id="recipientField">
                                        <label for="toStudentId" class="form-label">Student Roll Number</label>
                                        <input type="text" class="form-control" id="toStudentId" placeholder="e.g., 229X1A2847">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="messageSubject" class="form-label">Subject</label>
                                        <input type="text" class="form-control" id="messageSubject" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="messageBody" class="form-label">Message</label>
                                        <textarea class="form-control" id="messageBody" rows="5" required></textarea>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-paper-plane me-1"></i>Send Message
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-history me-2"></i>Recent Messages</h5>
                            </div>
                            <div class="card-body">
                                <div id="sentMessages">
                                    <p class="text-muted">No messages sent yet</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Success Modal (Enhanced) -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>Credential Issued Successfully
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="credentialDetails"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="issueAnother()">Issue Another</button>
            </div>
        </div>
    </div>
</div>

<!-- Revoke Modal -->
<div class="modal fade" id="revokeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="fas fa-ban me-2"></i>Revoke Credential
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to revoke this credential?</p>
                <p class="text-muted small">Revoked credentials remain on blockchain but become invalid.</p>
                
                <div class="mb-3">
                    <label for="revokeReason" class="form-label">Reason for Revocation *</label>
                    <select class="form-select" id="revokeReasonCategory">
                        <option value="duplicate">Duplicate Credential</option>
                        <option value="misconduct">Student Misconduct</option>
                        <option value="legal">Legal Requirement</option>
                        <option value="request">Student Request</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="revokeReasonText" class="form-label">Additional Details</label>
                    <textarea class="form-control" id="revokeReasonText" rows="3"></textarea>
                </div>
                
                <input type="hidden" id="revokeCredentialId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmRevoke()">
                    <i class="fas fa-ban me-1"></i>Revoke Credential
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Ticket Details Modal -->
<div class="modal fade" id="ticketModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ticket Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="ticketModalBody">
                <!-- Ticket details populated by JS -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Section navigation
function showSection(section) {
    // Hide all sections
    document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
    
    // Remove active class from all nav links
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    
    // Show selected section
    const sectionMap = {
        'issue': { id: 'issueSection', title: 'Issue New Credential', icon: 'fa-plus-circle' },
        'manage': { id: 'manageSection', title: 'Manage Credentials', icon: 'fa-list' },
        'search': { id: 'searchSection', title: 'Search Student', icon: 'fa-search' },
        'tickets': { id: 'ticketsSection', title: 'Student Tickets', icon: 'fa-ticket-alt' },
        'messages': { id: 'messagesSection', title: 'Messages', icon: 'fa-envelope' }
    };
    
    const selected = sectionMap[section];
    document.getElementById(selected.id).style.display = 'block';
    document.getElementById('sectionTitle').innerHTML = `<i class="fas ${selected.icon} text-primary me-2"></i>${selected.title}`;
    
    // Mark nav link as active
    event.target.classList.add('active');
    
    // Load data for section
    if (section === 'manage') loadCredentials();
    if (section === 'tickets') loadTickets();
}

// Issue credential
document.getElementById('issueCredentialForm').addEventListener('submit', function(e) {
    e.preventDefault();
    issueCredential();
});

function issueCredential() {
    const issueBtn = document.getElementById('issueBtn');
    const originalText = issueBtn.innerHTML;
    issueBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Issuing...';
    issueBtn.disabled = true;
    
    const formData = {
        student_name: document.getElementById('studentName').value,
        student_id: document.getElementById('studentId').value,
        degree: document.getElementById('degree').value,
        university: document.getElementById('university').value,
        gpa: parseFloat(document.getElementById('gpa').value),
        graduation_year: parseInt(document.getElementById('graduationYear').value),
        courses: document.getElementById('courses').value.split(',').map(c => c.trim()).filter(c => c),
        semester: document.getElementById('semester').value ? parseInt(document.getElementById('semester').value) : null,
        year: document.getElementById('year').value || null,
        class_name: document.getElementById('className').value || null,
        section: document.getElementById('section').value || null,
        backlog_count: parseInt(document.getElementById('backlogCount').value || 0),
        backlogs: document.getElementById('backlogs').value.split(',').map(c => c.trim()).filter(c => c),
        conduct: document.getElementById('conduct').value || null
    };
    
    fetch('/api/issue_credential', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessModal(data);
            clearForm();
            loadDashboardData();
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Network error occurred', 'danger');
    })
    .finally(() => {
        issueBtn.innerHTML = originalText;
        issueBtn.disabled = false;
    });
}

function showSuccessModal(data) {
    const credentialDetails = document.getElementById('credentialDetails');
    credentialDetails.innerHTML = `
        <div class="row">
            <div class="col-12">
                <h6>‚úÖ Credential Issued Successfully</h6>
                <table class="table table-sm table-bordered">
                    <tr class="table-primary">
                        <td colspan="2"><strong>üÜî IDENTITY</strong></td>
                    </tr>
                    <tr>
                        <td><strong>Credential ID:</strong></td>
                        <td><code>${data.credential_id}</code></td>
                    </tr>
                    <tr>
                        <td><strong>Version:</strong></td>
                        <td><span class="badge bg-primary">v${data.version || 1}</span></td>
                    </tr>
                    <tr>
                        <td><strong>Issuer ID:</strong></td>
                        <td><code>did:edu:gprec</code></td>
                    </tr>
                    
                    <tr class="table-warning">
                        <td colspan="2"><strong>üîê CRYPTOGRAPHIC PROOFS</strong></td>
                    </tr>
                    <tr>
                        <td><strong>Credential Hash:</strong></td>
                        <td><code class="small">${data.credential_hash ? data.credential_hash.substring(0, 32) + '...' : 'N/A'}</code></td>
                    </tr>
                    <tr>
                        <td><strong>Digital Signature:</strong></td>
                        <td><span class="badge bg-success">‚úì RSA-2048 Signed</span></td>
                    </tr>
                    
                    <tr class="table-info">
                        <td colspan="2"><strong>üíæ STORAGE & BLOCKCHAIN</strong></td>
                    </tr>
                    <tr>
                        <td><strong>IPFS CID:</strong></td>
                        <td><code>${data.ipfs_cid}</code></td>
                    </tr>
                    <tr>
                        <td><strong>Transaction Hash:</strong></td>
                        <td><code class="small">${data.tx_hash ? data.tx_hash.substring(0, 32) + '...' : data.transaction_id ? data.transaction_id.substring(0, 32) + '...' : 'N/A'}</code></td>
                    </tr>
                    <tr>
                        <td><strong>Block Hash:</strong></td>
                        <td><code class="small">${data.block_hash.substring(0, 32)}...</code></td>
                    </tr>
                    <tr>
                        <td><strong>Block Number:</strong></td>
                        <td><span class="badge bg-secondary">#${data.block_number}</span></td>
                    </tr>
                    <tr>
                        <td><strong>Network:</strong></td>
                        <td><span class="badge bg-dark">local-dev-chain</span></td>
                    </tr>
                    
                    <tr class="table-success">
                        <td colspan="2"><strong>üîÅ VERSIONING & LIFECYCLE</strong></td>
                    </tr>
                    <tr>
                        <td><strong>Status:</strong></td>
                        <td><span class="badge bg-success">ACTIVE</span></td>
                    </tr>
                    ${data.superseded_count > 0 ? `
                    <tr>
                        <td><strong>Superseded:</strong></td>
                        <td><span class="badge bg-warning text-dark">${data.superseded_count} previous version(s) marked as SUPERSEDED</span></td>
                    </tr>
                    ` : ''}
                    <tr>
                        <td><strong>Schema:</strong></td>
                        <td><code>AcademicTranscriptCredential v1.0</code></td>
                    </tr>
                </table>
                
                <div class="alert alert-info small mb-0">
                    <strong>‚ÑπÔ∏è Complete Metadata Generated:</strong><br>
                    ‚Ä¢ Issuer DID: <code>did:edu:gprec</code><br>
                    ‚Ä¢ Holder DID: <code>did:edu:gprec:student:${data.student_id || '...'}</code><br>
                    ‚Ä¢ SHA-256 Hash: ‚úì Computed<br>
                    ‚Ä¢ RSA Signature: ‚úì Applied<br>
                    ‚Ä¢ Transaction Reference: ‚úì Recorded<br>
                    ‚Ä¢ Lifecycle State: ‚úì Tracked<br>
                    ${data.superseded_count > 0 ? `‚Ä¢ Auto-Superseded ${data.superseded_count} old credential(s)` : ''}
                </div>
            </div>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('successModal'));
    modal.show();
}

function clearForm() {
    document.getElementById('issueCredentialForm').reset();
    document.getElementById('university').value = 'G. Pulla Reddy Engineering College';
    document.getElementById('backlogCount').value = '0';
}

function issueAnother() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('successModal'));
    modal.hide();
    clearForm();
}

// Load credentials
function loadCredentials() {
    const container = document.getElementById('credentialsTableContainer');
    container.innerHTML = '<p class="text-muted">Loading credentials...</p>';

    fetch('/api/credentials')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.credentials.length === 0) {
                    container.innerHTML = '<p class="text-muted">No credentials found.</p>';
                    return;
                }

                let html = `<div class="table-responsive"><table class="table table-sm table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Student</th>
                            <th>Roll No</th>
                            <th>Version</th>
                            <th>Status</th>
                            <th>GPA</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>`;

                data.credentials.forEach(c => {
                    const statusBadge = c.status === 'active' ? '<span class="badge bg-success">ACTIVE</span>' :
                                       c.status === 'revoked' ? '<span class="badge bg-danger">REVOKED</span>' :
                                       '<span class="badge bg-secondary">SUPERSEDED</span>';
                    
                    html += `
                        <tr>
                            <td><code class="small">${c.credential_id.slice(-8)}</code></td>
                            <td>${c.student_name || ''}</td>
                            <td><code>${c.student_id || ''}</code></td>
                            <td><span class="badge bg-primary">v${c.version || 1}</span></td>
                            <td>${statusBadge}</td>
                            <td>${c.gpa ? c.gpa.toFixed(2) : '-'}</td>
                            <td>${c.issue_date ? new Date(c.issue_date).toLocaleDateString() : ''}</td>
                            <td>
                                ${c.status === 'active' ? `
                                <button class="btn btn-sm btn-outline-danger" onclick="showRevokeModal('${c.credential_id}')">
                                    <i class="fas fa-ban"></i> Revoke
                                </button>
                                ` : '<span class="text-muted small">N/A</span>'}
                            </td>
                        </tr>`;
                });

                html += `</tbody></table></div>`;
                container.innerHTML = html;
            } else {
                container.innerHTML = '<p class="text-danger">Could not load credentials</p>';
            }
        })
        .catch(err => {
            console.error('Error loading credentials:', err);
            container.innerHTML = '<p class="text-danger">Network error loading credentials</p>';
        });
}

// Revoke credential
function showRevokeModal(credentialId) {
    document.getElementById('revokeCredentialId').value = credentialId;
    const modal = new bootstrap.Modal(document.getElementById('revokeModal'));
    modal.show();
}

function confirmRevoke() {
    const credentialId = document.getElementById('revokeCredentialId').value;
    const reason = document.getElementById('revokeReasonText').value;
    const category = document.getElementById('revokeReasonCategory').value;
    
    fetch('/api/revoke_credential', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            credential_id: credentialId,
            reason: reason,
            reason_category: category
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Credential revoked successfully', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('revokeModal'));
            modal.hide();
            loadCredentials();
            loadDashboardData();
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(err => {
        console.error('Revoke error:', err);
        showAlert('Network error while revoking credential', 'danger');
    });
}

// Search by student ID
function searchByStudentId() {
    const studentId = document.getElementById('searchStudentId').value.trim();
    if (!studentId) {
        showAlert('Please enter a roll number', 'warning');
        return;
    }
    
    const resultsDiv = document.getElementById('searchResults');
    resultsDiv.innerHTML = '<p class="text-muted">Searching...</p>';
    
    fetch(`/api/credential_history/${studentId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.credentials.length > 0) {
                let html = `<h6>Found ${data.total_versions} version(s) for ${studentId}:</h6>`;
                html += '<div class="table-responsive"><table class="table table-sm table-bordered">';
                html += '<thead class="table-dark"><tr><th>Version</th><th>Status</th><th>GPA</th><th>Sem/Yr</th><th>Issued</th><th>ID</th></tr></thead><tbody>';
                
                data.credentials.forEach(c => {
                    const statusBadge = c.status === 'active' ? '<span class="badge bg-success">ACTIVE</span>' :
                                       c.status === 'revoked' ? '<span class="badge bg-danger">REVOKED</span>' :
                                       '<span class="badge bg-secondary">SUPERSEDED</span>';
                    const semYear = c.semester ? `Sem ${c.semester}/Y${c.year || '?'}` : '-';
                    
                    html += `<tr>
                        <td><span class="badge bg-primary">v${c.version}</span></td>
                        <td>${statusBadge}</td>
                        <td>${c.gpa ? c.gpa.toFixed(2) : '-'}</td>
                        <td>${semYear}</td>
                        <td>${c.issued_at ? new Date(c.issued_at).toLocaleDateString() : '-'}</td>
                        <td><code class="small">${c.credential_id.slice(-8)}</code></td>
                    </tr>`;
                });
                
                html += '</tbody></table></div>';
                resultsDiv.innerHTML = html;
            } else {
                resultsDiv.innerHTML = '<div class="alert alert-warning">No credentials found for this student.</div>';
            }
        })
        .catch(err => {
            console.error('Search error:', err);
            resultsDiv.innerHTML = '<div class="alert alert-danger">Search error occurred</div>';
        });
}

// Load tickets (Kanban)
function loadTickets() {
    fetch('/api/tickets')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const todo = data.tickets.filter(t => t.status === 'todo');
                const inProgress = data.tickets.filter(t => t.status === 'in_progress');
                const completed = data.tickets.filter(t => t.status === 'completed');
                
                document.getElementById('todoColumn').innerHTML = renderTickets(todo);
                document.getElementById('inProgressColumn').innerHTML = renderTickets(inProgress);
                document.getElementById('completedColumn').innerHTML = renderTickets(completed);
                
                document.getElementById('ticketBadge').textContent = todo.length + inProgress.length;
                document.getElementById('pendingTicketsBadge').textContent = todo.length;
            }
        })
        .catch(err => console.error('Error loading tickets:', err));
}

function renderTickets(tickets) {
    if (tickets.length === 0) return '<p class="text-muted small">No tickets</p>';
    
    let html = '';
    tickets.forEach(t => {
        const priorityColor = t.priority === 'urgent' ? 'danger' : t.priority === 'medium' ? 'warning' : 'secondary';
        html += `
            <div class="card mb-2 ticket-card" onclick="viewTicket(${t.id})">
                <div class="card-body p-2">
                    <h6 class="card-title mb-1">${t.ticket_number}</h6>
                    <p class="card-text small text-muted mb-1">${t.issue_type}</p>
                    <p class="card-text small mb-1">${t.student_name} (${t.student_roll_number})</p>
                    <span class="badge bg-${priorityColor}">${t.priority}</span>
                </div>
            </div>
        `;
    });
    return html;
}

function viewTicket(ticketId) {
    // Show ticket details modal
    fetch(`/api/tickets`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const ticket = data.tickets.find(t => t.id === ticketId);
                if (ticket) {
                    document.getElementById('ticketModalBody').innerHTML = `
                        <p><strong>Ticket:</strong> ${ticket.ticket_number}</p>
                        <p><strong>Student:</strong> ${ticket.student_name} (${ticket.student_roll_number})</p>
                        <p><strong>Issue Type:</strong> ${ticket.issue_type}</p>
                        <p><strong>Description:</strong> ${ticket.description}</p>
                        <p><strong>Priority:</strong> <span class="badge bg-warning">${ticket.priority}</span></p>
                        <p><strong>Status:</strong> <span class="badge bg-info">${ticket.status}</span></p>
                        <hr>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-warning" onclick="updateTicketStatus(${ticketId}, 'todo')">To Do</button>
                            <button class="btn btn-sm btn-info" onclick="updateTicketStatus(${ticketId}, 'in_progress')">In Progress</button>
                            <button class="btn btn-sm btn-success" onclick="updateTicketStatus(${ticketId}, 'completed')">Completed</button>
                        </div>
                    `;
                    const modal = new bootstrap.Modal(document.getElementById('ticketModal'));
                    modal.show();
                }
            }
        });
}

function updateTicketStatus(ticketId, newStatus) {
    fetch(`/api/tickets/${ticketId}/status`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`Ticket status updated to ${newStatus}`, 'success');
            loadTickets();
            const modal = bootstrap.Modal.getInstance(document.getElementById('ticketModal'));
            if (modal) modal.hide();
        } else {
            showAlert('Error updating ticket: ' + data.error, 'danger');
        }
    });
}

// Messages
document.getElementById('sendMessageForm').addEventListener('submit', function(e) {
    e.preventDefault();
    sendMessage();
});

function toggleRecipientField() {
    const messageType = document.getElementById('messageType').value;
    const recipientField = document.getElementById('recipientField');
    recipientField.style.display = messageType === 'individual' ? 'block' : 'none';
}

function sendMessage() {
    const messageType = document.getElementById('messageType').value;
    const subject = document.getElementById('messageSubject').value;
    const body = document.getElementById('messageBody').value;
    
    if (messageType === 'individual') {
        const toStudentId = document.getElementById('toStudentId').value;
        if (!toStudentId) {
            showAlert('Please enter student roll number', 'warning');
            return;
        }
        
        fetch('/api/messages/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ to_student_id: toStudentId, subject, body })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Message sent successfully', 'success');
                document.getElementById('sendMessageForm').reset();
            } else {
                showAlert('Error: ' + data.error, 'danger');
            }
        });
    } else {
        fetch('/api/messages/broadcast', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ subject, body })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message_text, 'success');
                document.getElementById('sendMessageForm').reset();
            } else {
                showAlert('Error: ' + data.error, 'danger');
            }
        });
    }
}

// Dashboard data
function loadDashboardData() {
    fetch('/api/credentials')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('totalCredsBadge').textContent = data.credentials.length;
            }
        });
    
    loadTickets();
}

function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3" style="z-index: 9999; min-width: 300px;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', alertHtml);
    setTimeout(() => {
        const alert = document.querySelector('.alert');
        if (alert) alert.remove();
    }, 5000);
}

// Load on page load
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
});
</script>
xml
<style>
.sidebar {
    position: fixed;
    top: 56px;
    bottom: 0;
    left: 0;
    z-index: 100;
    padding: 0;
    box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
    overflow-y: auto;
}

/* BOLD SIDEBAR TEXT */
.sidebar .nav-link {
    font-weight: 700;
    color: #1a1a1a;
    padding: 0.75rem 1rem;
    font-size: 0.95rem;
}

.sidebar .nav-link.active {
    font-weight: 800;
    color: #0d6efd;
    background-color: #e7f1ff;
}

.sidebar .nav-link:hover {
    color: #0d6efd;
    background-color: #f8f9fa;
    font-weight: 700;
}

/* Portal title */
.sidebar h6 {
    font-weight: 700;
    color: #1a1a1a;
}

/* ULTRA BOLD: System Administrator / User name */
.sidebar .user-name-bold {
    font-weight: 900 !important; /* Maximum boldness */
    color: #000000 !important; /* Pure black */
    font-size: 0.9rem;
    display: block;
}

/* ULTRA BOLD: "Quick Stats" header */
.sidebar .stats-header-bold {
    font-weight: 900 !important; /* Maximum boldness */
    color: #000000 !important; /* Pure black */
    font-size: 0.875rem;
    display: block;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Bold stats labels */
.sidebar .px-3 .small {
    font-weight: 600;
    color: #2c3e50;
}

.ticket-card {
    cursor: pointer;
    transition: transform 0.2s;
}

.ticket-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

main {
    padding-top: 20px;
}
</style>

{% endblock %}
