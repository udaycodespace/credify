{% extends "base.html" %}

{% block title %}Verifier - Employer Portal{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="fas fa-shield-alt text-warning me-2"></i>Employer Portal</h2>
        <p class="text-muted mb-0">Verify the authenticity of academic credentials</p>
    </div>
</div>

<!-- ‚úÖ NEW: Tab Navigation -->
<ul class="nav nav-tabs mb-4" id="verifierTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="credential-tab" data-bs-toggle="tab" data-bs-target="#credentialVerification" type="button">
            <i class="fas fa-certificate me-1"></i>Credential Verification
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="disclosure-tab" data-bs-toggle="tab" data-bs-target="#disclosureVerification" type="button">
            <i class="fas fa-file-import me-1"></i>Selective Disclosure
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="zkp-tab" data-bs-toggle="tab" data-bs-target="#zkpVerification" type="button">
            <i class="fas fa-shield-alt me-1"></i>Zero-Knowledge Proofs
        </button>
    </li>
</ul>

<div class="tab-content" id="verifierTabContent">
    <!-- ==================== CREDENTIAL VERIFICATION TAB ==================== -->
    <div class="tab-pane fade show active" id="credentialVerification" role="tabpanel">
        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-search me-2"></i>Verify Credential</h5>
                    </div>
                    <div class="card-body">
                        <form id="verifyCredentialForm">
                            <div class="mb-3">
                                <label for="credentialId" class="form-label">Credential ID *</label>
                                <input type="text" class="form-control" id="credentialId" required 
                                       placeholder="Enter the credential ID to verify">
                                <div class="form-text">
                                    The credential ID is provided by the student or can be found in their selective disclosure proof.
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="submit" class="btn btn-warning" id="verifyBtn">
                                    <i class="fas fa-check-circle me-1"></i>Verify Credential
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Verification Results -->
                <div id="verificationResults" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-clipboard-check me-2"></i>Verification Results</h5>
                        </div>
                        <div class="card-body" id="verificationContent">
                            <!-- Results will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-info-circle me-2"></i>Verification Process</h6>
                    </div>
                    <div class="card-body">
                        <ol class="list-group list-group-numbered list-group-flush">
                            <li class="list-group-item border-0 px-0">Retrieve credential from IPFS</li>
                            <li class="list-group-item border-0 px-0">Verify blockchain integrity</li>
                            <li class="list-group-item border-0 px-0">Check cryptographic hash</li>
                            <li class="list-group-item border-0 px-0">Validate digital signature</li>
                            <li class="list-group-item border-0 px-0">Confirm authenticity</li>
                        </ol>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Security Checks</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-shield-alt text-success me-2"></i>
                            <small>Tamper Detection</small>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-signature text-success me-2"></i>
                            <small>Digital Signature Verification</small>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-link text-success me-2"></i>
                            <small>Blockchain Hash Validation</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-clock text-success me-2"></i>
                            <small>Issue Date Verification</small>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h6><i class="fas fa-lightbulb me-2"></i>Tips</h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled small mb-0">
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                Always verify credentials before making hiring decisions
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                Selective disclosure respects student privacy
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                Check the issuing institution's authenticity
                            </li>
                            <li>
                                <i class="fas fa-check text-success me-2"></i>
                                Look for valid digital signatures and hashes
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== SELECTIVE DISCLOSURE TAB ==================== -->
    <div class="tab-pane fade" id="disclosureVerification" role="tabpanel">
        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-file-import me-2"></i>Verify Selective Disclosure Proof</h5>
                    </div>
                    <div class="card-body">
                        <form id="verifyProofForm">
                            <div class="mb-3">
                                <label for="proofData" class="form-label">Selective Disclosure Proof *</label>
                                <textarea class="form-control" id="proofData" rows="6" required
                                          placeholder="Paste the selective disclosure proof JSON here..."></textarea>
                                <div class="form-text">
                                    Students can provide you with a selective disclosure proof that contains only specific fields.
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="submit" class="btn btn-info" id="verifyProofBtn">
                                    <i class="fas fa-key me-1"></i>Verify Proof
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Selective Disclosure Results -->
                <div id="disclosureResults" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-clipboard-check me-2"></i>Verification Results</h5>
                        </div>
                        <div class="card-body" id="disclosureContent">
                            <!-- Results will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-user-shield me-2"></i>Privacy-Preserving</h6>
                    </div>
                    <div class="card-body">
                        <p class="small">Selective disclosure allows students to share only necessary information while keeping other details private.</p>
                        <ul class="small mb-0">
                            <li>Students choose what to share</li>
                            <li>Cryptographically verified</li>
                            <li>Cannot be tampered with</li>
                            <li>Respects data minimization</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚úÖ NEW: ZKP VERIFICATION TAB -->
    <div class="tab-pane fade" id="zkpVerification" role="tabpanel">
        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5><i class="fas fa-shield-alt me-2"></i>Verify Zero-Knowledge Proof</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-success">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>What is ZKP?</strong> Students can prove claims about their credentials (e.g., "GPA > 7.5") WITHOUT revealing the actual value!
                        </div>

                        <form id="verifyZKPForm">
                            <div class="mb-3">
                                <label for="zkpProofData" class="form-label">Zero-Knowledge Proof JSON *</label>
                                <textarea class="form-control font-monospace" id="zkpProofData" rows="10" required
                                          placeholder='Paste the ZKP JSON here...'></textarea>
                                <div class="form-text">
                                    The student will provide you with a ZKP proof generated from their credential.
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="submit" class="btn btn-success" id="verifyZKPBtn">
                                    <i class="fas fa-check-circle me-1"></i>Verify ZKP
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- ZKP Results -->
                <div id="zkpResults" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-clipboard-check me-2"></i>ZKP Verification Results</h5>
                        </div>
                        <div class="card-body" id="zkpContent">
                            <!-- Results will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h6><i class="fas fa-info-circle me-2"></i>ZKP Types</h6>
                    </div>
                    <div class="card-body">
                        <h6 class="text-success">Range Proof</h6>
                        <p class="small mb-3">Proves a value is within a range without revealing the actual value.</p>
                        <p class="small text-muted mb-3"><strong>Example:</strong> "My GPA is greater than 7.5" (without showing it's 8.2)</p>
                        
                        <h6 class="text-info">Membership Proof</h6>
                        <p class="small mb-3">Proves an item exists in a set without revealing the entire set.</p>
                        <p class="small text-muted mb-0"><strong>Example:</strong> "I completed Data Structures" (without showing all 40 courses)</p>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h6><i class="fas fa-lock me-2"></i>Privacy Benefits</h6>
                    </div>
                    <div class="card-body">
                        <ul class="small mb-0">
                            <li class="mb-2">‚úÖ Students share only what's necessary</li>
                            <li class="mb-2">‚úÖ Prevents over-disclosure of personal data</li>
                            <li class="mb-2">‚úÖ Cryptographically secure proofs</li>
                            <li>‚úÖ Cannot be forged or manipulated</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ==================== ALL YOUR EXISTING FUNCTIONS - 100% PRESERVED ====================

document.getElementById('verifyCredentialForm').addEventListener('submit', function(e) {
    e.preventDefault();
    verifyCredential();
});

document.getElementById('verifyProofForm').addEventListener('submit', function(e) {
    e.preventDefault();
    verifySelectiveDisclosureProof();
});

function verifyCredential() {
    const credentialId = document.getElementById('credentialId').value.trim();
    if (!credentialId) {
        showAlert('Please enter a credential ID', 'warning');
        return;
    }
    
    const verifyBtn = document.getElementById('verifyBtn');
    const resultsDiv = document.getElementById('verificationResults');
    const contentDiv = document.getElementById('verificationContent');
    
    verifyBtn.disabled = true;
    verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Verifying...';
    
    resultsDiv.style.display = 'block';
    contentDiv.innerHTML = '<p class="text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Verifying credential...</p>';
    
    fetch('/api/verify_credential', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ credential_id: credentialId })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Verification response:', data);
        
        if (data.valid && data.status === 'active') {
            displayValidCredential(data);
        } else {
            displayInvalidCredential(data);
        }
        
        resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    })
    .catch(error => {
        console.error('Verification error:', error);
        contentDiv.innerHTML = `
            <div class="alert alert-danger">
                <h5><i class="fas fa-times-circle me-2"></i>Verification Error</h5>
                <p class="mb-0">Network error occurred. Please try again.</p>
            </div>
        `;
    })
    .finally(() => {
        verifyBtn.disabled = false;
        verifyBtn.innerHTML = '<i class="fas fa-check-circle me-1"></i>Verify Credential';
    });
}

function displayValidCredential(data) {
    const contentDiv = document.getElementById('verificationContent');
    const cred = data.credential;
    const subject = cred.credentialSubject;
    const registry = data.registry_entry || {};
    
    contentDiv.innerHTML = `
        <div class="alert alert-success">
            <h4><i class="fas fa-check-circle me-2"></i>‚úÖ Credential Verified Successfully!</h4>
            <p class="mb-0"><strong>Status:</strong> <span class="badge bg-success">ACTIVE & VALID</span></p>
        </div>
        
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-user-graduate me-2"></i>Student Information</h5>
            </div>
            <div class="card-body">
                <table class="table table-bordered table-sm mb-0">
                    <tr>
                        <th width="35%">Student Name:</th>
                        <td><strong>${subject.name}</strong></td>
                    </tr>
                    <tr>
                        <th>Roll Number:</th>
                        <td><code>${subject.studentId}</code></td>
                    </tr>
                    <tr>
                        <th>Degree:</th>
                        <td>${subject.degree}</td>
                    </tr>
                    <tr>
                        <th>University:</th>
                        <td>${subject.university}</td>
                    </tr>
                    <tr>
                        <th>GPA/CGPA:</th>
                        <td><span class="badge bg-info">${subject.gpa}</span></td>
                    </tr>
                    <tr>
                        <th>Graduation Year:</th>
                        <td>${subject.graduationYear}</td>
                    </tr>
                    ${subject.semester ? `
                    <tr>
                        <th>Semester:</th>
                        <td>Semester ${subject.semester}</td>
                    </tr>
                    ` : ''}
                    ${subject.year ? `
                    <tr>
                        <th>Year:</th>
                        <td>Year ${subject.year}</td>
                    </tr>
                    ` : ''}
                    ${subject.backlogCount !== undefined ? `
                    <tr>
                        <th>Backlog Count:</th>
                        <td><span class="badge ${subject.backlogCount > 0 ? 'bg-warning text-dark' : 'bg-success'}">${subject.backlogCount}</span></td>
                    </tr>
                    ` : ''}
                    ${subject.conduct ? `
                    <tr>
                        <th>Conduct:</th>
                        <td><span class="badge bg-secondary">${subject.conduct.toUpperCase()}</span></td>
                    </tr>
                    ` : ''}
                </table>
            </div>
        </div>
        
        <div class="card mb-3">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Verification Details</h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i><strong>Blockchain:</strong> Verified ‚úì</li>
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i><strong>Digital Signature:</strong> Valid ‚úì</li>
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i><strong>Hash Integrity:</strong> Confirmed ‚úì</li>
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i><strong>Status:</strong> Active ‚úì</li>
                    <li class="mb-2"><i class="fas fa-info-circle text-info me-2"></i><strong>Credential ID:</strong> <code>${cred.id || 'N/A'}</code></li>
                    <li class="mb-2"><i class="fas fa-info-circle text-info me-2"></i><strong>IPFS CID:</strong> <code>${registry.ipfs_cid || 'N/A'}</code></li>
                    <li><i class="fas fa-info-circle text-info me-2"></i><strong>Issued:</strong> ${new Date(cred.issuanceDate).toLocaleString()}</li>
                </ul>
            </div>
        </div>
    `;
}

function displayInvalidCredential(data) {
    const contentDiv = document.getElementById('verificationContent');
    
    let statusBadge, icon, title, details;
    
    switch(data.status) {
        case 'revoked':
            statusBadge = '<span class="badge bg-danger">REVOKED</span>';
            icon = 'fa-ban';
            title = 'üö´ Credential Revoked';
            details = `
                <p><strong>This credential has been officially revoked.</strong></p>
                <ul class="mb-0">
                    <li><strong>Revocation Reason:</strong> ${data.revocation_reason || 'Not specified'}</li>
                    <li><strong>Revoked On:</strong> ${data.details || 'Unknown'}</li>
                    <li><strong>Action Required:</strong> This credential is no longer valid for any purpose.</li>
                </ul>
            `;
            break;
            
        case 'superseded':
            statusBadge = '<span class="badge bg-warning text-dark">SUPERSEDED</span>';
            icon = 'fa-history';
            title = '‚ö†Ô∏è Old Version - Superseded';
            details = `
                <p><strong>This is an outdated version of the credential.</strong></p>
                <ul class="mb-0">
                    <li>A newer version exists for this student</li>
                    <li>This version is no longer considered current</li>
                    <li>Please contact the student for the latest credential</li>
                </ul>
            `;
            break;
            
        case 'tampered':
            statusBadge = '<span class="badge bg-danger">TAMPERED</span>';
            icon = 'fa-exclamation-triangle';
            title = '‚õî Credential Tampered / Fake';
            details = `
                <p><strong>This credential has been modified or is fake!</strong></p>
                <ul class="mb-0">
                    <li>The credential content does not match blockchain record</li>
                    <li>Hash verification failed</li>
                    <li>Possible forgery attempt detected</li>
                    <li><strong class="text-danger">DO NOT TRUST THIS CREDENTIAL</strong></li>
                </ul>
            `;
            break;
            
        case 'not_found':
            statusBadge = '<span class="badge bg-secondary">NOT FOUND</span>';
            icon = 'fa-question-circle';
            title = '‚ùì Credential Not Found';
            details = `
                <p><strong>This credential ID does not exist in our system.</strong></p>
                <ul class="mb-0">
                    <li>The credential ID may be incorrect</li>
                    <li>The credential was never issued by this institution</li>
                    <li>Possible fake credential attempt</li>
                </ul>
            `;
            break;
            
        default:
            statusBadge = '<span class="badge bg-danger">INVALID</span>';
            icon = 'fa-times-circle';
            title = '‚ùå Verification Failed';
            details = `
                <p><strong>Error:</strong> ${data.error || 'Unknown error'}</p>
                <p class="mb-0"><strong>Details:</strong> ${data.details || 'No additional information available'}</p>
            `;
    }
    
    contentDiv.innerHTML = `
        <div class="alert alert-danger">
            <h4><i class="fas ${icon} me-2"></i>${title}</h4>
            <p class="mb-2"><strong>Status:</strong> ${statusBadge}</p>
            <hr>
            ${details}
        </div>
        
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Additional Information</h6>
            </div>
            <div class="card-body">
                <p><strong>Credential ID:</strong> <code>${document.getElementById('credentialId').value}</code></p>
                <p class="mb-0"><strong>Recommendation:</strong> ${
                    data.status === 'superseded' ? 'Request the latest version from the student.' :
                    data.status === 'revoked' ? 'Do not accept this credential under any circumstances.' :
                    'Verify the credential ID and try again. If the issue persists, contact the issuing institution.'
                }</p>
            </div>
        </div>
    `;
}

function verifySelectiveDisclosureProof() {
    const verifyProofBtn = document.getElementById('verifyProofBtn');
    const originalText = verifyProofBtn.innerHTML;
    const proofData = document.getElementById('proofData').value.trim();
    const resultsDiv = document.getElementById('disclosureResults');
    const contentDiv = document.getElementById('disclosureContent');
    
    if (!proofData) {
        showAlert('Please enter a selective disclosure proof', 'warning');
        return;
    }
    
    try {
        const proof = JSON.parse(proofData);
        
        if (!proof.originalCredentialId) {
            showAlert('Invalid proof format: missing originalCredentialId', 'danger');
            return;
        }
        
        verifyProofBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Verifying...';
        verifyProofBtn.disabled = true;
        
        resultsDiv.style.display = 'block';
        contentDiv.innerHTML = '<p class="text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Verifying selective disclosure proof...</p>';
        
        fetch('/api/verify_credential', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ credential_id: proof.originalCredentialId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.valid) {
                displaySelectiveDisclosureResults(data, proof);
            } else {
                contentDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5><i class="fas fa-times-circle me-2"></i>Proof Verification Failed</h5>
                        <p>The original credential could not be verified: ${data.error}</p>
                    </div>
                `;
            }
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Network error occurred while verifying proof', 'danger');
        })
        .finally(() => {
            verifyProofBtn.innerHTML = originalText;
            verifyProofBtn.disabled = false;
        });
        
    } catch (error) {
        showAlert('Invalid JSON format in the proof data', 'danger');
    }
}

function displaySelectiveDisclosureResults(data, proof) {
    const contentDiv = document.getElementById('disclosureContent');
    
    let resultHtml = `
        <div class="alert alert-success">
            <h5><i class="fas fa-check-circle me-2"></i>‚úÖ Selective Disclosure Proof Verified!</h5>
            <p class="mb-0">The proof is valid and the original credential is authentic.</p>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="fas fa-eye me-2"></i>Disclosed Information</h6>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm mb-0">
    `;
    
    for (const [field, value] of Object.entries(proof.disclosedFields)) {
        resultHtml += `<tr><td><strong>${formatFieldName(field)}:</strong></td><td>${value}</td></tr>`;
    }
    
    resultHtml += `
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Proof Details</h6>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm mb-0">
                            <tr><td><strong>Original Credential:</strong></td><td><code class="small">${proof.originalCredentialId}</code></td></tr>
                            <tr><td><strong>Issuer:</strong></td><td>${proof.issuer.name}</td></tr>
                            <tr><td><strong>Issued:</strong></td><td>${new Date(proof.issuanceDate).toLocaleDateString()}</td></tr>
                            <tr><td><strong>Disclosed:</strong></td><td>${new Date(proof.disclosureDate).toLocaleDateString()}</td></tr>
                            <tr><td><strong>Fields Shown:</strong></td><td><span class="badge bg-info">${Object.keys(proof.disclosedFields).length}</span></td></tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="alert alert-info mt-3 mb-0">
            <i class="fas fa-shield-alt me-2"></i>
            <strong>Privacy Protected:</strong> This selective disclosure shows only the fields chosen by the student. 
            The full credential contains additional information that was not shared.
        </div>
    `;
    
    contentDiv.innerHTML = resultHtml;
}

function formatFieldName(field) {
    const fieldMap = {
        'name': 'Student Name',
        'studentId': 'Student ID / Roll Number',
        'degree': 'Degree Program',
        'university': 'University',
        'gpa': 'GPA/CGPA',
        'graduationYear': 'Graduation Year',
        'semester': 'Semester',
        'year': 'Year',
        'backlogCount': 'Backlog Count',
        'conduct': 'Conduct'
    };
    return fieldMap[field] || field.charAt(0).toUpperCase() + field.slice(1);
}

// ==================== ‚úÖ NEW: ZKP VERIFICATION FUNCTIONS ====================

document.getElementById('verifyZKPForm').addEventListener('submit', function(e) {
    e.preventDefault();
    verifyZKProof();
});

function verifyZKProof() {
    const zkpProofData = document.getElementById('zkpProofData').value.trim();
    const verifyZKPBtn = document.getElementById('verifyZKPBtn');
    const resultsDiv = document.getElementById('zkpResults');
    const contentDiv = document.getElementById('zkpContent');
    
    if (!zkpProofData) {
        showAlert('Please enter a ZKP proof', 'warning');
        return;
    }
    
    try {
        const proof = JSON.parse(zkpProofData);
        
        if (!proof.type) {
            showAlert('Invalid ZKP format: missing proof type', 'danger');
            return;
        }
        
        verifyZKPBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Verifying...';
        verifyZKPBtn.disabled = true;
        
        resultsDiv.style.display = 'block';
        contentDiv.innerHTML = '<p class="text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Verifying zero-knowledge proof...</p>';
        
        fetch('/api/zkp/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ proof: proof })
        })
        .then(response => response.json())
        .then(data => {
            if (data.valid) {
                displayZKPSuccess(data, proof);
            } else {
                displayZKPFailure(data);
            }
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        })
        .catch(error => {
            console.error('Error:', error);
            contentDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h5><i class="fas fa-times-circle me-2"></i>Verification Error</h5>
                    <p class="mb-0">Network error occurred. Please try again.</p>
                </div>
            `;
        })
        .finally(() => {
            verifyZKPBtn.innerHTML = '<i class="fas fa-check-circle me-1"></i>Verify ZKP';
            verifyZKPBtn.disabled = false;
        });
        
    } catch (error) {
        showAlert('Invalid JSON format in the ZKP proof', 'danger');
    }
}

function displayZKPSuccess(data, proof) {
    const contentDiv = document.getElementById('zkpContent');
    
    let proofTypeIcon, proofTypeName, claimHtml;
    
    if (proof.type === 'RangeProof') {
        proofTypeIcon = 'fa-greater-than-equal';
        proofTypeName = 'Range Proof';
        claimHtml = `
            <div class="alert alert-success">
                <h5><i class="fas fa-check-circle me-2"></i>‚úÖ Range Proof Verified!</h5>
                <p class="mb-0"><strong>Claim:</strong> ${data.claim}</p>
            </div>
            
            <div class="card mb-3">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="fas ${proofTypeIcon} me-2"></i>${proofTypeName} Details</h6>
                </div>
                <div class="card-body">
                    <table class="table table-sm mb-0">
                        <tr>
                            <th width="40%">Field:</th>
                            <td><strong>${proof.field}</strong></td>
                        </tr>
                        <tr>
                            <th>Minimum Threshold:</th>
                            <td><span class="badge bg-primary">${proof.minThreshold !== null ? proof.minThreshold : 'None'}</span></td>
                        </tr>
                        <tr>
                            <th>Maximum Threshold:</th>
                            <td><span class="badge bg-primary">${proof.maxThreshold !== null ? proof.maxThreshold : 'Unlimited'}</span></td>
                        </tr>
                        <tr>
                            <th>Range Satisfied:</th>
                            <td><span class="badge bg-success">‚úì YES</span></td>
                        </tr>
                        <tr>
                            <th>Proof Method:</th>
                            <td><code>${proof.proofMethod}</code></td>
                        </tr>
                        <tr>
                            <th>Proof Date:</th>
                            <td>${new Date(proof.proofDate).toLocaleString()}</td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <div class="alert alert-info mb-0">
                <i class="fas fa-lock me-2"></i>
                <strong>Privacy Note:</strong> The student has proven that their ${proof.field} satisfies the range requirement 
                WITHOUT revealing the actual value. This is cryptographically secure and cannot be forged.
            </div>
        `;
    } else if (proof.type === 'MembershipProof') {
        proofTypeIcon = 'fa-check-circle';
        proofTypeName = 'Membership Proof';
        claimHtml = `
            <div class="alert alert-success">
                <h5><i class="fas fa-check-circle me-2"></i>‚úÖ Membership Proof Verified!</h5>
                <p class="mb-0"><strong>Claim:</strong> ${data.claim}</p>
            </div>
            
            <div class="card mb-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas ${proofTypeIcon} me-2"></i>${proofTypeName} Details</h6>
                </div>
                <div class="card-body">
                    <table class="table table-sm mb-0">
                        <tr>
                            <th width="40%">Field:</th>
                            <td><strong>${proof.field}</strong></td>
                        </tr>
                        <tr>
                            <th>Claimed Member:</th>
                            <td><span class="badge bg-success">"${proof.claimedMember}"</span></td>
                        </tr>
                        <tr>
                            <th>Set Size:</th>
                            <td><span class="badge bg-primary">${proof.setSize} items</span></td>
                        </tr>
                        <tr>
                            <th>Membership Verified:</th>
                            <td><span class="badge bg-success">‚úì YES</span></td>
                        </tr>
                        <tr>
                            <th>Proof Method:</th>
                            <td><code>${proof.proofMethod}</code></td>
                        </tr>
                        <tr>
                            <th>Merkle Root:</th>
                            <td><code class="small">${proof.merkleRoot.substring(0, 32)}...</code></td>
                        </tr>
                        <tr>
                            <th>Proof Date:</th>
                            <td>${new Date(proof.proofDate).toLocaleString()}</td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <div class="alert alert-info mb-0">
                <i class="fas fa-lock me-2"></i>
                <strong>Privacy Note:</strong> The student has proven that "${proof.claimedMember}" exists in their ${proof.field} 
                WITHOUT revealing the complete list of ${proof.setSize} items. This uses Merkle tree cryptography.
            </div>
        `;
    } else {
        claimHtml = `
            <div class="alert alert-success">
                <h5><i class="fas fa-check-circle me-2"></i>‚úÖ Proof Verified!</h5>
                <p class="mb-0">${data.claim}</p>
            </div>
        `;
    }
    
    contentDiv.innerHTML = `
        ${claimHtml}
        
        <div class="card mt-3">
            <div class="card-header bg-dark text-white">
                <h6 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Cryptographic Verification</h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i><strong>Digital Signature:</strong> Valid ‚úì</li>
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i><strong>Commitment:</strong> Verified ‚úì</li>
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i><strong>Credential ID:</strong> <code>${proof.credentialId}</code></li>
                    <li><i class="fas fa-check text-success me-2"></i><strong>Cannot be forged or manipulated</strong></li>
                </ul>
            </div>
        </div>
    `;
}

function displayZKPFailure(data) {
    const contentDiv = document.getElementById('zkpContent');
    
    contentDiv.innerHTML = `
        <div class="alert alert-danger">
            <h5><i class="fas fa-times-circle me-2"></i>‚ùå ZKP Verification Failed</h5>
            <p class="mb-2"><strong>Error:</strong> ${data.error}</p>
            <p class="mb-0"><strong>Details:</strong> ${data.details || 'The zero-knowledge proof could not be verified. It may be invalid, tampered with, or expired.'}</p>
        </div>
        
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Recommendation</h6>
            </div>
            <div class="card-body">
                <p class="mb-0">
                    <strong>‚ö†Ô∏è Do not accept this proof.</strong> The cryptographic verification has failed. 
                    Request the student to generate a new proof or provide the full credential for verification.
                </p>
            </div>
        </div>
    `;
}

// ==================== UTILITY FUNCTION ====================

function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3" style="z-index: 9999; min-width: 300px;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', alertHtml);
    
    setTimeout(() => {
        const alert = document.querySelector('.alert');
        if (alert) alert.remove();
    }, 5000);
}
</script>
{% endblock %}
