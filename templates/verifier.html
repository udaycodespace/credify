{% extends "base.html" %}

{% block title %}Verifier - Employer Portal{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="fas fa-shield-alt text-warning me-2"></i>Employer Portal</h2>
        <p class="text-muted mb-0">Verify the authenticity of academic credentials</p>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-search me-2"></i>Verify Credential</h5>
            </div>
            <div class="card-body">
                <form id="verifyCredentialForm">
                    <div class="mb-3">
                        <label for="credentialId" class="form-label">Credential ID *</label>
                        <input type="text" class="form-control" id="credentialId" required 
                               placeholder="Enter the credential ID to verify">
                        <div class="form-text">
                            The credential ID is provided by the student or can be found in their selective disclosure proof.
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="submit" class="btn btn-warning" id="verifyBtn">
                            <i class="fas fa-check-circle me-1"></i>Verify Credential
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-file-import me-2"></i>Verify Selective Disclosure Proof</h5>
            </div>
            <div class="card-body">
                <form id="verifyProofForm">
                    <div class="mb-3">
                        <label for="proofData" class="form-label">Selective Disclosure Proof *</label>
                        <textarea class="form-control" id="proofData" rows="6" required
                                  placeholder="Paste the selective disclosure proof JSON here..."></textarea>
                        <div class="form-text">
                            Students can provide you with a selective disclosure proof that contains only specific fields.
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="submit" class="btn btn-info" id="verifyProofBtn">
                            <i class="fas fa-key me-1"></i>Verify Proof
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Verification Results -->
        <div id="verificationResults" class="mt-4" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-clipboard-check me-2"></i>Verification Results</h5>
                </div>
                <div class="card-body" id="verificationContent">
                    <!-- Results will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-info-circle me-2"></i>Verification Process</h6>
            </div>
            <div class="card-body">
                <ol class="list-group list-group-numbered list-group-flush">
                    <li class="list-group-item border-0 px-0">Retrieve credential from IPFS</li>
                    <li class="list-group-item border-0 px-0">Verify blockchain integrity</li>
                    <li class="list-group-item border-0 px-0">Check cryptographic hash</li>
                    <li class="list-group-item border-0 px-0">Validate digital signature</li>
                    <li class="list-group-item border-0 px-0">Confirm authenticity</li>
                </ol>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6><i class="fas fa-exclamation-triangle me-2"></i>Security Checks</h6>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-shield-alt text-success me-2"></i>
                    <small>Tamper Detection</small>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-signature text-success me-2"></i>
                    <small>Digital Signature Verification</small>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-link text-success me-2"></i>
                    <small>Blockchain Hash Validation</small>
                </div>
                <div class="d-flex align-items-center">
                    <i class="fas fa-clock text-success me-2"></i>
                    <small>Issue Date Verification</small>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6><i class="fas fa-lightbulb me-2"></i>Tips</h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled small mb-0">
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Always verify credentials before making hiring decisions
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Selective disclosure respects student privacy
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Check the issuing institution's authenticity
                    </li>
                    <li>
                        <i class="fas fa-check text-success me-2"></i>
                        Look for valid digital signatures and hashes
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('verifyCredentialForm').addEventListener('submit', function(e) {
    e.preventDefault();
    verifyCredential();
});

document.getElementById('verifyProofForm').addEventListener('submit', function(e) {
    e.preventDefault();
    verifySelectiveDisclosureProof();
});

function verifyCredential() {
    const verifyBtn = document.getElementById('verifyBtn');
    const originalText = verifyBtn.innerHTML;
    const credentialId = document.getElementById('credentialId').value.trim();
    
    if (!credentialId) {
        showAlert('Please enter a credential ID', 'warning');
        return;
    }
    
    // Show loading state
    verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Verifying...';
    verifyBtn.disabled = true;
    
    fetch('/api/verify_credential', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ credential_id: credentialId })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Verification response:', data);
        displayVerificationResults(data, 'credential');
    })
    .catch(error => {
        console.error('Full error details:', error);
        console.error('Error message:', error.message);
        console.error('Error stack:', error.stack);
        showAlert('Error: ' + error.message + '. Please check the browser console for details.', 'danger');
    })
    .finally(() => {
        verifyBtn.innerHTML = originalText;
        verifyBtn.disabled = false;
    });
}

function verifySelectiveDisclosureProof() {
    const verifyProofBtn = document.getElementById('verifyProofBtn');
    const originalText = verifyProofBtn.innerHTML;
    const proofData = document.getElementById('proofData').value.trim();
    
    if (!proofData) {
        showAlert('Please enter a selective disclosure proof', 'warning');
        return;
    }
    
    try {
        const proof = JSON.parse(proofData);
        
        // Show loading state
        verifyProofBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Verifying...';
        verifyProofBtn.disabled = true;
        
        // First verify the original credential
        fetch('/api/verify_credential', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ credential_id: proof.originalCredentialId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.valid) {
                data.selective_disclosure_proof = proof;
                displayVerificationResults(data, 'selective_disclosure');
            } else {
                displayVerificationResults(data, 'credential');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Network error occurred while verifying proof', 'danger');
        })
        .finally(() => {
            verifyProofBtn.innerHTML = originalText;
            verifyProofBtn.disabled = false;
        });
        
    } catch (error) {
        showAlert('Invalid JSON format in the proof data', 'danger');
        verifyProofBtn.innerHTML = originalText;
        verifyProofBtn.disabled = false;
    }
}

function displayVerificationResults(data, type) {
    const resultsDiv = document.getElementById('verificationResults');
    const contentDiv = document.getElementById('verificationContent');
    
    console.log('Displaying results for data:', data);
    console.log('Type:', type);
    // Ensure resultHtml is defined for both branches
    let resultHtml = '';

    if (data.valid) {
        // Success - credential is valid
        resultHtml = `
            <div class="alert alert-success">
                <i class="fas fa-check-circle me-2"></i>
                <strong>Verification Successful!</strong> This credential is authentic and valid.
            </div>
        `;
        
        if (type === 'selective_disclosure' && data.selective_disclosure_proof) {
            // Display selective disclosure information
            const proof = data.selective_disclosure_proof;
            resultHtml += `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Disclosed Information:</h6>
                        <table class="table table-sm">
            `;
            
            for (const [field, value] of Object.entries(proof.disclosedFields)) {
                resultHtml += `<tr><td><strong>${formatFieldName(field)}:</strong></td><td>${value}</td></tr>`;
            }
            
            resultHtml += `
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Verification Details:</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Original Credential ID:</strong></td><td><code>${proof.originalCredentialId}</code></td></tr>
                            <tr><td><strong>Issuer:</strong></td><td>${proof.issuer.name}</td></tr>
                            <tr><td><strong>Issue Date:</strong></td><td>${new Date(proof.issuanceDate).toLocaleDateString()}</td></tr>
                            <tr><td><strong>Disclosure Date:</strong></td><td>${new Date(proof.disclosureDate).toLocaleDateString()}</td></tr>
                        </table>
                    </div>
                </div>
                
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    This is a selective disclosure proof. Only the fields shown above were disclosed by the student.
                    The original credential contains additional information that was not shared.
                </div>
            `;
        } else {
            // Display full credential information
            const cred = data.credential;
            const subject = cred.credentialSubject;
            
            resultHtml += `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Student Information:</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Name:</strong></td><td>${subject.name}</td></tr>
                            <tr><td><strong>Student ID:</strong></td><td>${subject.studentId}</td></tr>
                            <tr><td><strong>Degree:</strong></td><td>${subject.degree}</td></tr>
                            <tr><td><strong>University:</strong></td><td>${subject.university}</td></tr>
                            <tr><td><strong>GPA:</strong></td><td>${subject.gpa}</td></tr>
                            <tr><td><strong>Graduation Year:</strong></td><td>${subject.graduationYear}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Verification Details:</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Credential ID:</strong></td><td><code>${cred.id}</code></td></tr>
                            <tr><td><strong>Issuer:</strong></td><td>${cred.issuer.name}</td></tr>
                            <tr><td><strong>Issue Date:</strong></td><td>${new Date(cred.issuanceDate).toLocaleDateString()}</td></tr>
                            <tr><td><strong>Blockchain Verified:</strong></td><td><span class="badge bg-success">✓</span></td></tr>
                            <tr><td><strong>Signature Verified:</strong></td><td><span class="badge bg-success">✓</span></td></tr>
                            <tr><td><strong>Hash Verified:</strong></td><td><span class="badge bg-success">✓</span></td></tr>
                        </table>
                    </div>
                </div>
            `;
            
            if (subject.courses && subject.courses.length > 0) {
                resultHtml += `
                    <div class="mt-3">
                        <h6>Courses:</h6>
                        <div class="row">
                            ${subject.courses.map(course => `
                                <div class="col-md-4 mb-1">
                                    <span class="badge bg-info">${course}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }
        
    } else {
        // Error - credential is invalid
        resultHtml = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Verification Failed!</strong> ${data.error}
            </div>
            
            <div class="mt-3">
                <h6>Possible Reasons:</h6>
                <ul class="mb-0">
                    <li>The credential ID is incorrect or doesn't exist</li>
                    <li>The credential has been tampered with</li>
                    <li>The digital signature is invalid</li>
                    <li>The blockchain integrity has been compromised</li>
                    <li>The credential has been revoked</li>
                </ul>
            </div>
        `;
    }
    
    contentDiv.innerHTML = resultHtml;
    resultsDiv.style.display = 'block';
    
    // Scroll to results
    resultsDiv.scrollIntoView({ behavior: 'smooth' });
}

function formatFieldName(field) {
    const fieldMap = {
        'name': 'Student Name',
        'studentId': 'Student ID',
        'degree': 'Degree Program',
        'university': 'University',
        'gpa': 'GPA',
        'graduationYear': 'Graduation Year'
    };
    return fieldMap[field] || field;
}

function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    const container = document.querySelector('.container');
    container.insertAdjacentHTML('afterbegin', alertHtml);
    
    setTimeout(() => {
        const alert = container.querySelector('.alert');
        if (alert) {
            alert.remove();
        }
    }, 5000);
}
</script>
{% endblock %}
